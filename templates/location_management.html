{% extends "dashboard/base_dashboard.html" %}
{% load static %}

{% block content %}
<div class="w-full flex flex-col items-center py-8 ">
    
    <!-- Header Section (W-1184px) -->
    <div class="w-[1184px] h-20 bg-white border-b border-gray-200 flex items-center px-6">
        <div class="flex-grow">
            <h1 class="text-gray-900 text-2xl font-bold">Location Families</h1>
            <p class="text-gray-600 text-sm font-normal mt-1">Manage location families and types for service requests</p>
        </div>

        <!-- Search and Icons -->
        <div class="w-80 h-10 flex items-center gap-4">
          <div class="relative">
            <div class="bg-white rounded-lg outline outline-1 outline-offset-[-1px] outline-gray-200">
              <input
                id="searchInput"
                type="text"
                placeholder="Search locations families..."
                class="w-64 h-10 px-9 rounded-lg text-gray-400 text-base font-normal font-['Inter'] outline-none"
                data-name="{{ family.name|lower }}"
              />
            </div>
            <div class="absolute left-[12px] top-[9px]">
              <img src="{% static 'icon/search.svg' %}" class="w-4 h-4" alt="search icon">
            </div>
          </div>

          <div class="w-7 h-10 relative rounded-lg"></div>
          <div class="w-7 h-10 relative rounded-lg"></div>
        </div>
      </div>
    <!-- </div> -->

    <!-- Sub Tab -->
    {% include "partials/location_tab.html" %}

    <!-- Location Families Section -->
    <div class="w-[1184px] mx-auto py-8 space-y-6">
      <!-- <div class="w-[1136px] left-[24px] top-[24px] relative"> -->

        <!-- Section Header -->
        <div class="flex justify-start gap-120 items-center mb-2  bg-white py-4">
          <div>
            <div class="text-gray-900 text-xl font-semibold font-['Inter'] px-6">Location Families</div>
            <div class="text-gray-600 text-sm font-normal font-['Inter'] px-6">
              Group related location types together for better organization
            </div>
          </div><div class="flex items-center gap-4">
          <form method="POST" action="{% url 'bulk_import_families' %}" enctype="multipart/form-data">
        {% csrf_token %}
        <label class="flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white text-base font-medium px-3 py-2 rounded-lg cursor-pointer transition">
            <img src="{% static 'icon/import.svg' %}" class="w-4 h-4" alt="Import">
            <span>Import</span>
            <input type="file" name="csv_file" class="hidden" onchange="this.form.submit()">
        </label>
    </form>
          <div class="w-32 h-9 bg-sky-600 rounded-lg relative">
            <img src="{% static 'icon/plus.svg' %}" class="absolute left-[19px] top-[9px] w-3 h-3.5" alt="plus icon">
            <a href="{% url 'family_add' %}" class="absolute left-[40px] top-[9px] text-white text-sm font-medium font-['Inter']">
              Add Family
            </a>
          </div>
        </div>
        </div>
        <!-- Families Grid -->
        <div class="grid grid-cols-3 gap-6 mt-12">
          {% for family in families %}
          <div
            class="w-96 h-64 bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow  outline outline-1 outline-offset-[-1px] outline-gray-200 relative family-card"
            data-name="{{ family.name|lower }}"
          >

            <!-- Family Header -->
            <div class="flex justify-between items-center px-6 pt-4">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-sky-600/10 rounded-lg flex justify-center items-center">
                  <div class="w-5 h-3.5 bg-sky-600"></div>
                </div>

                <div>
                  <div class="text-gray-900 text-base font-semibold font-['Inter'] truncate">{{ family.name }}</div>
                  <div class="text-gray-600 text-xs font-normal font-['Inter']">+{{ family.types.count }} location types</div>
                </div>
              </div>


              <!-- Dots Menu -->
              <div class="relative inline-block">
                <button
                  type="button"
                  class="dot-btn w-6 h-6 flex items-center justify-center rounded hover:bg-gray-100 focus:outline-none"
                  aria-haspopup="true"
                  aria-expanded="false"
                  title="Options"
                >
                  <img src="{% static 'icon/dot.svg' %}" class="w-4 h-4" alt="options">
                </button>

                <div class="menu hidden absolute right-0 mt-2 w-36 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                  <a href="{% url 'family_edit' family.family_id %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">‚úèÔ∏è Edit</a>
                  <a
                    href="{% url 'family_delete' family.family_id %}"
                    class="block px-4 py-2 text-sm text-red-600 hover:bg-red-100"
                    onclick="return confirm('Are you sure you want to delete this family?')"
                  >
                    üóë Delete
                  </a>
                </div>
              </div>
            </div>

            <!-- Location Types -->
            <div class="px-6 mt-4">
              {% for loc in family.types.all|slice:":5" %}
              <div class="flex justify-between items-center py-1">
                <div class="text-gray-600 text-sm font-normal font-['Inter']">{{ loc.name }}</div>
                <div class="w-12 h-6 rounded-full {{ loc.is_active|yesno:'bg-green-500/10,bg-red-500/10' }}">
                  {% if loc.is_active %}
                  <div class="text-green-500 text-xs font-normal font-['Inter'] text-center">Active</div>
                  {% else %}
                  <div class="text-red-500 text-xs font-normal font-['Inter'] text-center">Inactive</div>
                  {% endif %}
                </div>
              </div>
              {% endfor %}

              {% if family.types.count > 5 %}
<div class="text-gray-400 text-xs font-normal font-['Inter'] mt-2 show-all-types cursor-pointer" 
     data-family-id="{{ family.family_id }}">
    +{{ family.types.count|add:"-5" }} more types
</div>
{% endif %}
            </div>
<div id="allTypesModal{{ family.family_id }}" 
     class="fixed inset-0 z-[1000] hidden flex items-center justify-center bg-black/40 backdrop-blur-md">
    <div class="bg-white w-96 max-h-[400px] rounded-xl shadow-lg overflow-y-auto p-6 relative">
        <h3 class="text-lg font-semibold mb-4">{{ family.name }} - All Location Types</h3>
        <ul class="list-disc list-inside text-sm text-gray-600">
            {% for loc in family.types.all %}
            <li>{{ loc.name }} {% if loc.is_active %}(Active){% else %}(Inactive){% endif %}</li>
            {% endfor %}
        </ul>
        <button onclick="document.getElementById('allTypesModal{{ family.family_id }}').classList.add('hidden')" 
                class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
    </div>
</div>

            <!-- Checklist -->
            {% if default_checklist %}
            <div class="absolute bottom-3 left-6 right-6 border-t border-gray-200 pt-2 flex justify-between items-center">
              <div class="text-gray-600 text-xs font-normal font-['Inter']">Default Checklist:</div>
              <div class="text-gray-600 text-xs font-medium font-['Inter'] truncate">{{ default_checklist.name }}</div>
            </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>

      </div>
    </div>
  </div>
</div>

<!-- JS Section -->
<script>
  document.getElementById('searchInput').addEventListener('input', function() {
    const query = this.value.toLowerCase();
    document.querySelectorAll('.family-card').forEach(card => {
      const name = card.dataset.name;
      card.style.display = name.includes(query) ? 'block' : 'none';
    });
  });

  document.getElementById('searchInput').addEventListener('input', function() {
    fetch(`/locations/search/?q=${encodeURIComponent(this.value)}`)
      .then(r => r.json())
      .then(data => console.log('Search results:', data.results));
  });

  document.getElementById('addFamilyBtn')?.addEventListener('click', function() {
    const name = prompt('Enter new family name:');
    if (!name) return;

    const csrftoken = '{{ csrf_token }}';
    fetch('{% url "add_family" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrftoken
      },
      body: new URLSearchParams({ name })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        alert('Family added successfully!');
        location.href = `/locations/${data.family_id}/`;
      } else {
        alert('Error: ' + (data.error || 'Unknown error'));
      }
    });
  });

  document.addEventListener('DOMContentLoaded', function() {
    document.body.addEventListener('click', function(event) {
      const btn = event.target.closest('.dot-btn');
      if (btn) {
        const wrapper = btn.closest('.relative');
        const menu = wrapper.querySelector('.menu');

        document.querySelectorAll('.menu').forEach(m => {
          if (m !== menu) m.classList.add('hidden');
        });

        menu.classList.toggle('hidden');
        btn.setAttribute('aria-expanded', !menu.classList.contains('hidden'));
        return;
      }

      if (!event.target.closest('.relative')) {
        document.querySelectorAll('.menu').forEach(m => m.classList.add('hidden'));
        document.querySelectorAll('.dot-btn').forEach(b => b.setAttribute('aria-expanded', 'false'));
      }
    });

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        document.querySelectorAll('.menu').forEach(m => m.classList.add('hidden'));
        document.querySelectorAll('.dot-btn').forEach(b => b.setAttribute('aria-expanded', 'false'));
      }
    });
  });

  document.querySelectorAll('.show-all-types').forEach(el => {
    el.addEventListener('click', () => {
        const familyId = el.dataset.familyId;
        const modal = document.getElementById(`allTypesModal${familyId}`);
        modal.classList.remove('hidden');
    });
});
</script>
<style>
  body.modal-open #sidebar {
    display: none;
}
</style>
{% endblock %}
