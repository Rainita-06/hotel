{% extends 'base.html' %} {% load user_extras %} {% block content %}
<div class="container-fluid">
  <h2>Master Users</h2>

  <div class="mb-3">
    <input
      id="searchInput"
      class="form-control"
      placeholder="Search users by name, email or username..."
    />
  </div>

  <div class="mb-3 d-flex justify-content-between">
    <div>
      <button id="bulkDeleteBtn" class="btn btn-danger">Delete Selected</button>
      <a href="{% url 'export_users' %}" class="btn btn-secondary"
        >Export CSV</a
      >
    </div>
    <div>
      <a href="/admin/auth/user/add/" class="btn btn-primary">Add User</a>
    </div>
  </div>

  <table class="table table-striped" id="usersTable">
    <thead>
      <tr>
        <th><input type="checkbox" id="selectAll" /></th>
        <th>ID</th>
        <th>Username</th>
        <th>Full name</th>
        <th>Department</th>
        <th>Groups</th>
        <th>Active</th>
      </tr>
    </thead>
    <tbody>
      {% for user in users %}
      <tr>
        <td>
          <input type="checkbox" class="selectRow" value="{{ user.id }}" />
        </td>
        <td>{{ user.id }}</td>
        <td>{{ user.username }}</td>
        <td>{{ user.get_full_name }}</td>
        <td>{{ user|department_name }}</td>
        <td>{{ user.groups.all|join:", " }}</td>
        <td>{{ user.is_active }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  (function () {
    const searchInput = document.getElementById("searchInput");
    const table = document.getElementById("usersTable");

    // Search filter
    searchInput.addEventListener("input", function () {
      const q = this.value.toLowerCase();
      const rows = table.querySelectorAll("tbody tr");
      rows.forEach((r) => {
        const text = r.innerText.toLowerCase();
        r.style.display = text.indexOf(q) > -1 ? "" : "none";
      });
    });

    // Select all checkboxes
    document
      .getElementById("selectAll")
      .addEventListener("change", function () {
        const checked = this.checked;
        document
          .querySelectorAll(".selectRow")
          .forEach((cb) => (cb.checked = checked));
      });

    // Bulk delete
    document
      .getElementById("bulkDeleteBtn")
      .addEventListener("click", function () {
        const ids = Array.from(
          document.querySelectorAll(".selectRow:checked")
        ).map((cb) => cb.value);
        if (!ids.length) {
          alert("No users selected");
          return;
        }
        if (!confirm("Delete selected users? This cannot be undone.")) return;
        fetch('{% url "bulk_delete_users" %}', {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}",
          },
          body: JSON.stringify({ ids }),
        }).then((r) => {
          if (r.ok) location.reload();
          else alert("Failed");
        });
      });
  })();
</script>
{% endblock %}
