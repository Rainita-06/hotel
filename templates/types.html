{% extends "dashboard/base_dashboard.html" %}
{% load static %}
{% block content %}
<div class="w-full flex flex-col items-center py-8 ">
    
    <!-- Header Section (W-1184px) -->
    <div class="w-[1184px] h-20 bg-white border-b border-gray-200 flex items-center px-6">
        <div class="flex-grow">
            <h1 class="text-gray-900 text-2xl font-bold">Location Types</h1>
            <p class="text-gray-600 text-sm font-normal mt-1">Manage location families and types for service requests</p>
        </div>
        <div class="w-80 h-10 bg-black/0 border-gray-200 flex justify-start items-center gap-4">
            <div class="w-64 h-10 relative bg-black/0 border-gray-200">
                <div class="w-64 h-10 left-0 top-0  bg-white rounded-lg outline outline-1 outline-offset-[-1px] outline-gray-200">
                    <input id="searchInput"
             type="text"
             placeholder="Search types..." class="w-64 h-10 left-[60px] top-0  px-9 rounded lg  text-gray-400 text-base font-normal font-['Inter'] leading-normal outline-none" data-name="{{ types.name|lower }}"/>
                </div>
                <div class="w-4 h-6 left-[12px] top-[9px] absolute bg-black/0 border-gray-200">
                    <div class="w-4 h-4 left-0 top-[4px] absolute inline-flex justify-center items-center">
                        <img src="{% static 'icon/search.svg'%}" class="w-4 h-4 relative bg-black/0 border-gray-200 overflow-hidden">
                            <!-- <div class="w-4 h-4 left-0 top-0 absolute bg-gray-400"></div> -->
                        <!-- </div> -->
                    </div>
                </div>
            </div>
            <div class="w-7 h-10 relative bg-black/0 rounded-lg border-gray-200">
                <div class="w-3.5 h-5 left-[8px] top-[10px] absolute bg-black/0 border-gray-200">
                    <div class="w-3.5 h-4 left-0 top-[2px] absolute inline-flex justify-center items-center">
                        <div class="w-3.5 h-4 relative bg-black/0 border-gray-200 overflow-hidden">
                            <!-- <div class="w-3.5 h-4 left-0 top-0 absolute bg-gray-600"></div> -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="w-7 h-10 relative bg-black/0 rounded-lg border-gray-200">
                <div class="w-3.5 h-5 left-[8px] top-[10px] absolute bg-black/0 border-gray-200">
                    <div class="w-3.5 h-4 left-0 top-[2px] absolute inline-flex justify-center items-center">
                        <div class="w-3.5 h-4 relative bg-black/0 border-gray-200 overflow-hidden">
                            <!-- <div class="w-3.5 h-4 left-0 top-0 absolute bg-gray-600"></div> -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<!-- </div> -->
<!-- sub tab -->
{% include "partials/location_tab.html" %}



 <div class="w-[1184px] mx-auto py-8 space-y-6">
      <!-- <div class="w-[1136px] left-[24px] top-[24px] relative"> -->

        <!-- Section Header -->
        <div class="flex justify-between items-center mb-2  bg-white py-4">
          <div>
            <div class="text-gray-900 text-xl font-semibold font-['Inter'] px-6">Location Types</div>
            <div class="text-gray-600 text-sm font-normal font-['Inter'] px-6">
              Group related location types together for better organization
            </div>
          </div>
            <div class="flex items-center gap-4">
          <form method="POST" action="{% url 'bulk_import_types' %}" enctype="multipart/form-data">
        {% csrf_token %}
        <label class="flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white text-base font-medium px-3 py-2 rounded-lg cursor-pointer transition">
            <img src="{% static 'icon/import.svg' %}" class="w-4 h-4" alt="Import">
            <span>Import</span>
            <input type="file" name="csv_file" class="hidden" onchange="this.form.submit()">
        </label>
    </form>
            <div class="w-32 h-9 relative bg-sky-600 rounded-lg border-gray-200">
                <div class="w-3 h-4 left-[19.72px] top-[9px] absolute bg-black/0 border-gray-200">
                    <div class="w-3 h-3.5 left-0 top-[1.75px] absolute inline-flex justify-center items-center">
                        <img src="{% static 'icon/plus.svg'%}" class="w-3 h-3.5 relative bg-black/0 border-gray-200 overflow-hidden">
                            <!-- <div class="w-3 h-3 left-[0.44px] top-[1.31px] absolute bg-white"></div> -->
                        <!-- </div> -->
                    </div>
                </div>
                <a href="{% url 'type_add' %}" class="w-20 h-5 left-[39.97px] top-[9px] absolute text-center justify-start text-white text-sm font-medium font-['Inter']">Add Types</a>
            </div>
        </div>
        </div>

        <div class="w-[1184px] mt-24 grid grid-cols-3 gap-6">
 {% for t in types %}
    <div class="w-96 h-64 bg-white rounded-xl shadow-[0px_1px_2px_0px_rgba(0,0,0,0.05)] outline outline-1 outline-offset-[-1px] outline-gray-200 relative types-card" data-name="{{ t.name|lower }}">
        
        <div class="w-80 h-10 left-[25px] top-[25px] relative bg-black/0 border-gray-200 inline-flex justify-between items-center">
            <div class="w-40 h-10 bg-black/0 border-gray-200 flex justify-start items-center gap-3">
                <div class="w-10 h-10 bg-sky-600/10 rounded-lg border-gray-200 flex justify-center items-center">
                    <div class="w-5 h-6 relative bg-black/0 border-gray-200">
                        <div class="w-5 h-4 left-0 top-[4px]  inline-flex justify-center items-center">
                            <div class="w-5 h-4 relative bg-black/0 border-gray-200 overflow-hidden">
                                <div class="w-5 h-3.5 left-0 top-[1px] absolute bg-sky-600"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="w-24 h-10 relative bg-black/0 border-gray-200">
                    <div class="w-24 h-6 left-0 top-0 absolute bg-black/0 border-gray-200">
                        <div class="w-24 h-6 left-0 top-[2px] absolute justify-start text-gray-900 text-base font-semibold font-['Inter'] truncate whitespace-nowrap overflow-hidden">{{ t.name }}</div>
                    </div>
                    <div class="w-24 h-4 left-0 top-[24px] absolute bg-black/0 border-gray-200">
                        <div class="w-24 h-4 left-0 top-0 absolute justify-start text-gray-600 text-xs font-normal font-['Inter']">Family name:{{ t.family.name }} </div>
                    </div>
                </div>
            </div>
           <!-- inside your loop -->
<div class="relative inline-block" data-type-id="{{ t.type_id }}">
  <button
    type="button"
    class="dot-btn w-6 h-6 flex items-center justify-center rounded hover:bg-gray-100 focus:outline-none"
    aria-haspopup="true"
    aria-expanded="false"
    title="Options">
    <img src="{% static 'icon/dot.svg' %}" class="w-4 h-4" alt="options">
  </button>

  <div class="menu hidden absolute right-0 mt-2 w-36 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
    <a href="{% url 'type_edit' t.type_id %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">‚úèÔ∏è Edit</a>
    <a href="{% url 'type_delete' t.type_id %}" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-100"   onclick="return confirm('Are you sure you want to delete this type?')">üóë Delete</a>
  </div>
</div>

        </div>

        <!-- <div class="w-80 h-28 left-[25px] top-[81px] absolute bg-black/0 border-gray-200">
            <div class="w-80 h-6 left-0 top-0 relative bg-black/0 border-gray-200 inline-flex justify-between items-center">
                {% for loc in family.types.all|slice:":5" %}
                <div class="w-24 h-5 relative bg-black/0 border-gray-200">
                    <div class="w-24 h-5 left-0 top-[1px] absolute justify-start text-gray-600 text-sm font-normal font-['Inter']">{{ loc.name }}</div>
                </div>
                <div class="w-12 h-6 relative bg-green-500/10 rounded-full border-gray-200">
                    {% if loc.is_active %}
                    <div class="w-10 h-4 left-[8px] top-[4px] absolute justify-start text-green-500 text-xs font-normal font-['Inter']">Active</div>
                    {%else %}
                    <div class="w-10 h-4 left-[8px] top-[4px] absolute justify-start text-red-500 text-xs font-normal font-['Inter']">Inactive</div>
                    {% endif %}
                </div>
                {% endfor %}
                {% if family.types.count > 5 %}
                <div class="w-80 h-4 left-0 top-[96px] relative bg-black/0 border-gray-200">
                    <div class="w-20 h-4 left-0 top-0 relative justify-start text-gray-400 text-xs font-normal font-['Inter']">+{{ family.types.count|add:"-5" }} more types</div>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="w-80 h-8 left-[25px] top-[209px] absolute bg-black/0 border-t border-gray-200">
            <div class="w-80 h-4 left-0 top-[17px] relative bg-black/0 border-gray-200 inline-flex justify-between items-center">
                {% if default_checklist %}
                <div class="w-24 h-4 relative bg-black/0 border-gray-200">
                    <div class="w-24 h-4 left-0 top-0 absolute justify-start text-gray-600 text-xs font-normal font-['Inter'] truncate">Default Checklist:</div>
                </div>
                <div class="w-20 h-4 relative bg-black/0 border-gray-200">
                    <div class="w-20 h-4 left-0 top-0 absolute justify-start text-gray-600 text-xs font-medium font-['Inter']truncate whitespace-nowrap overflow-hidden">{{ default_checklist.name }}</div>
                </div>
                {% endif %}
            </div>
        </div> -->

    </div>
    {% endfor %}
</div>
    </div></div>
<!-- <script>
document.getElementById('searchInput').addEventListener('input', function() {
  const query = this.value.toLowerCase();
  document.querySelectorAll('.types-card').forEach(card => {
    const name = card.dataset.name;
    card.style.display = name.includes(query) ? 'block' : 'none';
  });
}); 

document.getElementById('searchInput').addEventListener('input', function () {
  fetch(`/locations/search/?q=${encodeURIComponent(this.value)}`)
    .then(r => r.json())
    .then(data => {
      console.log('Search results:', data.results);
    });
});

document.getElementById('addFamilyBtn').addEventListener('click', function () {
  const name = prompt('Enter new family name:');
  if (!name) return;

  const csrftoken = '{{ csrf_token }}';
  fetch('{% url "add_family" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': csrftoken
    },
    body: new URLSearchParams({name})
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      alert('Family added successfully!');
      location.href = `/locations/${data.family_id}/`;
    } else {
      alert('Error: ' + (data.error || 'Unknown error'));
    }
  });
});

function toggleMenu(button) {
    const menu = button.nextElementSibling;
    // Hide all other open menus first
    document.querySelectorAll(".relative .absolute").forEach(el => {
        if (el !== menu) el.classList.add("hidden");
    });
    // Toggle this one
    menu.classList.toggle("hidden");
}

// Optional: close menu when clicking outside
document.addEventListener("click", function(event) {
    if (!event.target.closest(".relative")) {
        document.querySelectorAll(".relative .absolute").forEach(el => el.classList.add("hidden"));
    }
});

document.addEventListener('DOMContentLoaded', function () {
  // Global click handler (delegation)
  document.body.addEventListener('click', function (event) {
    const btn = event.target.closest('.dot-btn');
    if (btn) {
      // Toggle the menu for the clicked button
      const wrapper = btn.closest('.relative');
      const menu = wrapper.querySelector('.menu');

      // Close other menus first
      document.querySelectorAll('.menu').forEach(m => {
        if (m !== menu) m.classList.add('hidden');
      });

      menu.classList.toggle('hidden');

      // update aria-expanded
      const expanded = !menu.classList.contains('hidden');
      btn.setAttribute('aria-expanded', expanded);
      return; // button click handled
    }

    // If click is outside any .relative wrapper, close all menus
    if (!event.target.closest('.relative')) {
      document.querySelectorAll('.menu').forEach(m => m.classList.add('hidden'));
      // reset aria-expanded for any opened buttons
      document.querySelectorAll('.dot-btn').forEach(b => b.setAttribute('aria-expanded', 'false'));
    }
  });

  // Close menus on Escape key
  document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') {
      document.querySelectorAll('.menu').forEach(m => m.classList.add('hidden'));
      document.querySelectorAll('.dot-btn').forEach(b => b.setAttribute('aria-expanded', 'false'));
    }
  });
});
</script>
 -->
<script>
// Search functionality
document.getElementById('searchInput').addEventListener('input', function() {
  const query = this.value.toLowerCase();
  document.querySelectorAll('.types-card').forEach(card => {
    const name = card.dataset.name;
    card.style.display = name.includes(query) ? 'block' : 'none';
  });
});

// Dropdown menu functionality
document.addEventListener('DOMContentLoaded', function() {
  // Handle dropdown menu clicks
  document.addEventListener('click', function(event) {
    const dotBtn = event.target.closest('.dot-btn');
    const menu = event.target.closest('.menu');
    
    // If clicked on a dot button
    if (dotBtn) {
      const wrapper = dotBtn.closest('.relative');
      const targetMenu = wrapper.querySelector('.menu');
      
      // Close all other menus
      document.querySelectorAll('.menu').forEach(m => {
        if (m !== targetMenu) m.classList.add('hidden');
      });
      
      // Toggle current menu
      targetMenu.classList.toggle('hidden');
      dotBtn.setAttribute('aria-expanded', !targetMenu.classList.contains('hidden'));
      return;
    }
    
    // If clicked outside any menu
    if (!menu) {
      document.querySelectorAll('.menu').forEach(m => m.classList.add('hidden'));
      document.querySelectorAll('.dot-btn').forEach(b => b.setAttribute('aria-expanded', 'false'));
    }
  });

  // Close menus on Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      document.querySelectorAll('.menu').forEach(m => m.classList.add('hidden'));
      document.querySelectorAll('.dot-btn').forEach(b => b.setAttribute('aria-expanded', 'false'));
    }
  });
});
</script>

{% endblock %}