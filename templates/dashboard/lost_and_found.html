{% extends "dashboard/base_dashboard.html" %}
{% load static %}
{% load dashboard2_extras %}

{% block extra_css %}
<style>
    html {
        scroll-behavior: smooth;
    }
    
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-slide-in-up {
        opacity: 0;
        animation: slideInUp 0.6s ease-out forwards;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .status-open { background: #fef3c7; color: #92400e; }
    .status-found { background: #dbeafe; color: #1e40af; }
    .status-returned { background: #d1fae5; color: #065f46; }
    
    .priority-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .priority-low { background: #e5e7eb; color: #374151; }
    .priority-normal { background: #dbeafe; color: #1e40af; }
    .priority-high { background: #fed7aa; color: #9a3412; }
    .priority-urgent { background: #fecaca; color: #991b1b; }
    
    .item-type-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .type-guest_left { background: #fae8ff; color: #86198f; }
    .type-guest_lost { background: #ffedd5; color: #9a3412; }
    .type-staff_found { background: #dcfce7; color: #166534; }

    .autocomplete-list {
        position: absolute;
        z-index: 50;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 0.5rem;
        margin-top: 0.25rem;
        max-height: 12rem;
        overflow-y: auto;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
    }

    .autocomplete-item {
        padding: 0.5rem 0.75rem;
        cursor: pointer;
    }

    .autocomplete-item:hover {
        background: #eff6ff;
    }
    
    .stat-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        cursor: pointer;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    }
    
    .stat-card.active {
        ring: 2px;
        ring-color: #0ea5e9;
        border-color: #0ea5e9;
    }
    
    /* Status dropdown styles */
    .status-dropdown {
        position: relative;
        display: inline-block;
    }
    
    .status-dropdown-content {
        display: none;
        position: absolute;
        right: 0;
        background-color: white;
        min-width: 160px;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        border-radius: 0.5rem;
        border: 1px solid #e5e7eb;
        overflow: hidden;
    }
    
    .status-dropdown-content.show {
        display: block;
    }
    
    .status-dropdown-item {
        padding: 0.5rem 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        transition: background-color 0.15s;
    }
    
    .status-dropdown-item:hover {
        background-color: #f3f4f6;
    }
    
    /* Table row hover actions */
    .table-row-actions {
        opacity: 0;
        transition: opacity 0.2s;
    }
    
    tr:hover .table-row-actions {
        opacity: 1;
    }
</style>
{% endblock extra_css %}

{% block content %}
<div class="w-full max-w-[1184px] mx-auto bg-transparent">

    <!-- Header -->
    <div class="w-full h-20 bg-white border-b border-gray-200 flex items-center px-6">
        <div class="w-full flex justify-between items-center">
            <div>
                <h1 class="text-gray-900 text-2xl font-bold font-['Inter']">Lost & Found</h1>
                <p class="text-gray-600 text-sm font-normal font-['Inter']">Track and manage lost items reported by guests and staff</p>
            </div>
            
            <div class="flex items-center gap-4">
                <form autocomplete="off" id="searchForm" method="get" class="relative flex items-center gap-2">
                    <div class="relative">
                        <img src="{% static 'images/tickets/search.svg' %}" alt="Search Icon" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5" />
                        <input autocomplete="off" type="text" name="q" placeholder="Search items..." value="{{ search_query|default:'' }}" class="w-64 h-10 pl-10 pr-4 bg-white rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-sky-500" />
                    </div>
                    <button type="submit" class="h-10 px-4 bg-sky-600 text-white font-medium rounded-lg hover:bg-sky-700 transition-colors">
                        Search
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="p-6">
        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="stat-card bg-white rounded-xl shadow-sm border border-gray-200 p-4 {% if not status_filter %}ring-2 ring-sky-500{% endif %}" data-action="total">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm font-medium">Total Items</p>
                        <p class="text-2xl font-bold text-gray-900">{{ stats.total }}</p>
                    </div>
                    <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="stat-card bg-white rounded-xl shadow-sm border border-gray-200 p-4 {% if status_filter == 'open' %}ring-2 ring-yellow-500{% endif %}" data-status="open">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm font-medium">Open</p>
                        <p class="text-2xl font-bold text-yellow-600">{{ stats.open }}</p>
                    </div>
                    <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="stat-card bg-white rounded-xl shadow-sm border border-gray-200 p-4 {% if status_filter == 'found' %}ring-2 ring-blue-500{% endif %}" data-status="found">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm font-medium">Found</p>
                        <p class="text-2xl font-bold text-blue-600">{{ stats.found }}</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="stat-card bg-white rounded-xl shadow-sm border border-gray-200 p-4 {% if status_filter == 'returned' %}ring-2 ring-green-500{% endif %}" data-status="returned">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm font-medium">Returned</p>
                        <p class="text-2xl font-bold text-green-600">{{ stats.returned }}</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-gray-900 text-lg font-semibold font-['Inter']">Lost & Found Items</h2>
                <div class="flex gap-2">
                    <a href="#" id="exportBtn" class="h-10 px-4 bg-white border border-gray-300 text-gray-700 rounded-lg flex items-center justify-center gap-2 hover:bg-gray-50 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        <span>Export</span>
                    </a>
                    <button id="openCreateModal" class="h-10 px-4 bg-sky-600 rounded-lg text-white flex items-center justify-center gap-2 hover:bg-sky-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        <span>Report Item</span>
                    </button>
                </div>
            </div>
            
            <!-- Filters -->
            <div class="flex flex-wrap gap-4 mb-6">
                <select id="statusFilter" class="h-10 px-4 bg-white border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                    <option value="">All Status</option>
                    {% for value, label in status_choices %}
                    <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
                
                <select id="typeFilter" class="h-10 px-4 bg-white border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                    <option value="">All Types</option>
                    {% for value, label in type_choices %}
                    <option value="{{ value }}" {% if item_type_filter == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
                
                <select id="priorityFilter" class="h-10 px-4 bg-white border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                    <option value="">All Priorities</option>
                    {% for value, label in priority_choices %}
                    <option value="{{ value }}" {% if priority_filter == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
                
                <button id="applyFilters" class="h-10 px-4 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                    Apply Filters
                </button>
                
                {% if status_filter or item_type_filter or priority_filter or search_query %}
                <a href="{% url 'dashboard:lost_and_found' %}" class="h-10 px-4 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                    Clear Filters
                </a>
                {% endif %}
            </div>
            
            <!-- Items Table -->
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-200">
                            <th class="text-left py-3 px-4 text-gray-600 text-sm font-medium">Item</th>
                            <th class="text-left py-3 px-4 text-gray-600 text-sm font-medium">Type</th>
                            <th class="text-left py-3 px-4 text-gray-600 text-sm font-medium">Guest/Room</th>
                            <th class="text-left py-3 px-4 text-gray-600 text-sm font-medium">Status</th>
                            <th class="text-left py-3 px-4 text-gray-600 text-sm font-medium">Priority</th>
                            <th class="text-left py-3 px-4 text-gray-600 text-sm font-medium">Reported</th>
                            <th class="text-left py-3 px-4 text-gray-600 text-sm font-medium">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                        <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors" data-item-id="{{ item.id }}">
                            <td class="py-4 px-4">
                                <div>
                                    <a href="{% url 'dashboard:lost_and_found_detail' item.id %}" class="text-gray-900 font-medium hover:text-sky-600 transition-colors">
                                        {{ item.item_name }}
                                    </a>
                                    {% if item.item_category %}
                                    <p class="text-gray-500 text-sm">{{ item.item_category }}</p>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="py-4 px-4">
                                <span class="item-type-badge type-{{ item.item_type }}">
                                    {{ item.get_item_type_display }}
                                </span>
                            </td>
                            <td class="py-4 px-4">
                                <div>
                                    {% if item.guest_name %}
                                    <p class="text-gray-900 text-sm">{{ item.guest_name }}</p>
                                    {% endif %}
                                    {% if item.room_number %}
                                    <p class="text-gray-500 text-sm">Room {{ item.room_number }}</p>
                                    {% elif item.found_location_description %}
                                    <p class="text-gray-500 text-sm">{{ item.found_location_description }}</p>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="py-4 px-4">
                                <div class="status-dropdown">
                                    <button type="button" class="status-badge status-{{ item.status }} cursor-pointer hover:opacity-80 flex items-center gap-1" onclick="toggleStatusDropdown({{ item.id }})">
                                        {{ item.get_status_display }}
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div id="statusDropdown-{{ item.id }}" class="status-dropdown-content">
                                        <div class="status-dropdown-item" onclick="updateItemStatus({{ item.id }}, 'open')">
                                            <span class="w-2 h-2 rounded-full bg-yellow-500"></span> Open
                                        </div>
                                        <div class="status-dropdown-item" onclick="updateItemStatus({{ item.id }}, 'found')">
                                            <span class="w-2 h-2 rounded-full bg-blue-500"></span> Found
                                        </div>
                                        <div class="status-dropdown-item" onclick="updateItemStatus({{ item.id }}, 'returned')">
                                            <span class="w-2 h-2 rounded-full bg-green-500"></span> Returned
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="py-4 px-4">
                                <span class="priority-badge priority-{{ item.priority }}">
                                    {{ item.get_priority_display }}
                                </span>
                            </td>
                            <td class="py-4 px-4">
                                <div>
                                    <p class="text-gray-900 text-sm">{{ item.reported_at|date:"d M Y" }}</p>
                                    <p class="text-gray-500 text-xs">{{ item.reported_at|time:"H:i" }}</p>
                                </div>
                            </td>
                            <td class="py-4 px-4">
                                <div class="flex items-center gap-2">
                                    <a href="{% url 'dashboard:lost_and_found_detail' item.id %}" class="text-sky-600 hover:text-sky-800 text-sm font-medium">
                                        View
                                    </a>
                                    {% if not item.is_broadcast %}
                                    <button onclick="broadcastItem({{ item.id }})" class="text-orange-600 hover:text-orange-800 text-sm font-medium">
                                        Broadcast
                                    </button>
                                    {% else %}
                                    <span class="text-green-600 text-xs">
                                        <svg class="w-4 h-4 inline" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                        </svg>
                                        Broadcasted
                                    </span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="py-12 text-center">
                                <div class="flex flex-col items-center">
                                    <svg class="w-16 h-16 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                    </svg>
                                    <p class="text-gray-500 text-lg font-medium">No items found</p>
                                    <p class="text-gray-400 text-sm">Start by reporting a lost or found item</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Create Item Modal -->
<div id="createItemModal" class="fixed inset-0 z-[9999] hidden">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" onclick="closeModal()"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-gray-900">Report Lost/Found Item</h2>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
            </div>
            
            <form id="createItemForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Item Type *</label>
                    <select name="item_type" required class="w-full h-10 px-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500">
                        {% for value, label in type_choices %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Item Name *</label>
                    <input type="text" name="item_name" required placeholder="e.g., Black Wallet, iPhone 14, Passport" class="w-full h-10 px-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" />
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea name="item_description" rows="3" placeholder="Describe the item in detail..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                    <select name="item_category" class="w-full h-10 px-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <option value="">Select category</option>
                        <option value="Electronics">Electronics</option>
                        <option value="Clothing">Clothing</option>
                        <option value="Documents">Documents</option>
                        <option value="Jewelry">Jewelry</option>
                        <option value="Bags">Bags</option>
                        <option value="Keys">Keys</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Room Number</label>
                    <input type="text" name="room_number" placeholder="e.g., 101" class="w-full h-10 px-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" />
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Building</label>
                        <input type="text" name="building" placeholder="e.g., Main Building" class="w-full h-10 px-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Floor</label>
                        <input type="text" name="floor" placeholder="e.g., 1st Floor" class="w-full h-10 px-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" />
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                    <select name="priority" class="w-full h-10 px-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500">
                        {% for value, label in priority_choices %}
                        <option value="{{ value }}" {% if value == 'normal' %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Found Location</label>
                    <input type="text" name="found_location_description" placeholder="e.g., Near pool, In lobby, Restaurant" class="w-full h-10 px-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" />
                </div>
                
                <div class="border-t border-gray-200 pt-4">
                    <h3 class="text-sm font-medium text-gray-900 mb-3">Guest Information (Optional)</h3>
                    <div class="space-y-3">
                        <div class="relative">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Guest Name</label>
                            <input type="text" name="guest_name" id="guestNameInput" placeholder="Search guest..." class="w-full h-10 px-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" />
                            <div id="guestAutocomplete" class="autocomplete-list hidden"></div>
                            <input type="hidden" name="voucher_id" id="voucherIdInput" />
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                <input type="text" name="guest_phone" placeholder="+1234567890" class="w-full h-10 px-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input type="email" name="guest_email" placeholder="guest@email.com" class="w-full h-10 px-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" />
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <input type="checkbox" name="broadcast" id="broadcastCheckbox" class="w-4 h-4 text-sky-600 border-gray-300 rounded focus:ring-sky-500" />
                    <label for="broadcastCheckbox" class="text-sm text-gray-700">ðŸ”” Broadcast to all staff immediately</label>
                </div>
                
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="px-6 py-2 bg-sky-600 text-white rounded-lg hover:bg-sky-700 transition-colors">
                        Report Item
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
    const csrfToken = '{{ csrf_token }}';
    
    // Modal functions
    function openModal() {
        document.getElementById('createItemModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
    
    function closeModal() {
        document.getElementById('createItemModal').classList.add('hidden');
        document.body.style.overflow = '';
        // Reset form
        document.getElementById('createItemForm').reset();
    }
    
    document.getElementById('openCreateModal').addEventListener('click', openModal);
    
    // Form submission
    document.getElementById('createItemForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        formData.set('broadcast', document.getElementById('broadcastCheckbox').checked ? 'true' : 'false');
        
        try {
            const response = await fetch("{% url 'dashboard:api_lost_and_found_create' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                closeModal();
                showToast('Item reported successfully!', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast('Error: ' + (data.error || 'Failed to report item'), 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('An error occurred. Please try again.', 'error');
        }
    });
    
    // Status dropdown toggle
    function toggleStatusDropdown(itemId) {
        // Close all other dropdowns first
        document.querySelectorAll('.status-dropdown-content.show').forEach(dropdown => {
            dropdown.classList.remove('show');
        });
        
        const dropdown = document.getElementById(`statusDropdown-${itemId}`);
        dropdown.classList.toggle('show');
    }
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.status-dropdown')) {
            document.querySelectorAll('.status-dropdown-content.show').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
        }
    });
    
    // Update item status
    async function updateItemStatus(itemId, newStatus) {
        try {
            const formData = new FormData();
            formData.append('action', 'update_status');
            formData.append('status', newStatus);
            
            const response = await fetch(`/dashboard/api/lost-and-found/${itemId}/update/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast('Status updated successfully!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Error: ' + (data.error || 'Failed to update status'), 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('An error occurred. Please try again.', 'error');
        }
    }
    
    // Broadcast item
    async function broadcastItem(itemId) {
        if (!confirm('Broadcast this item to all staff?')) return;
        
        try {
            const response = await fetch(`/dashboard/api/lost-and-found/${itemId}/broadcast/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast('Item broadcast to all staff!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Error: ' + (data.error || 'Failed to broadcast item'), 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('An error occurred. Please try again.', 'error');
        }
    }
    
    // Filters logic
    function applyFilters() {
        const status = document.getElementById('statusFilter').value;
        const type = document.getElementById('typeFilter').value;
        const priority = document.getElementById('priorityFilter').value;
        
        const params = new URLSearchParams();
        if (status) params.set('status', status);
        if (type) params.set('item_type', type);
        if (priority) params.set('priority', priority);
        
        const searchInput = document.querySelector('input[name="q"]');
        if (searchInput && searchInput.value) {
            params.set('q', searchInput.value);
        }
        
        window.location.href = '?' + params.toString();
    }

    document.getElementById('applyFilters').addEventListener('click', applyFilters);
    
    // Make stat cards clickable
    document.querySelectorAll('.stat-card').forEach(card => {
        card.addEventListener('click', function() {
            const status = this.getAttribute('data-status');
            if (status) {
                const urlParams = new URLSearchParams(window.location.search);
                urlParams.set('status', status);
                window.location.href = '?' + urlParams.toString();
            } else if (this.getAttribute('data-action') === 'total') {
                window.location.href = window.location.pathname; // Clear filters
            }
        });
    });
    
    // Guest autocomplete
    let autocompleteTimeout = null;
    const guestNameInput = document.getElementById('guestNameInput');
    const guestAutocomplete = document.getElementById('guestAutocomplete');
    const voucherIdInput = document.getElementById('voucherIdInput');
    
    guestNameInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        clearTimeout(autocompleteTimeout);
        
        if (query.length < 2) {
            guestAutocomplete.classList.add('hidden');
            return;
        }
        
        autocompleteTimeout = setTimeout(async () => {
            try {
                const response = await fetch(`{% url 'dashboard:api_lost_and_found_search_guests' %}?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.success && data.results.length > 0) {
                    guestAutocomplete.innerHTML = data.results.map(result => `
                        <div class="autocomplete-item" 
                             onclick="selectGuest('${result.name}', ${result.voucher_id}, '${result.room}', '${result.phone || ''}', '${result.email || ''}')">
                            <div class="font-medium">${result.name}</div>
                            <div class="text-sm text-gray-500">Room ${result.room} | ${result.check_in} - ${result.check_out}</div>
                        </div>
                    `).join('');
                    guestAutocomplete.classList.remove('hidden');
                } else {
                    guestAutocomplete.classList.add('hidden');
                }
            } catch (error) {
                console.error('Autocomplete error:', error);
            }
        }, 300);
    });
    
    function selectGuest(name, voucherId, room, phone, email) {
        guestNameInput.value = name;
        voucherIdInput.value = voucherId;
        
        // Fill in room and contact info
        document.querySelector('input[name="room_number"]').value = room || '';
        document.querySelector('input[name="guest_phone"]').value = phone || '';
        document.querySelector('input[name="guest_email"]').value = email || '';
        
        guestAutocomplete.classList.add('hidden');
    }
    
    // Close autocomplete on outside click
    document.addEventListener('click', function(e) {
        if (!guestNameInput.contains(e.target) && !guestAutocomplete.contains(e.target)) {
            guestAutocomplete.classList.add('hidden');
        }
    });

    // Export button
    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const status = document.getElementById('statusFilter').value;
            const type = document.getElementById('typeFilter').value;
            const priority = document.getElementById('priorityFilter').value;
            
            const params = new URLSearchParams();
            if (status) params.set('status', status);
            if (type) params.set('item_type', type);
            if (priority) params.set('priority', priority);
            
            const searchInput = document.querySelector('input[name="q"]');
            if (searchInput && searchInput.value) {
                params.set('q', searchInput.value);
            }
            
            window.location.href = "{% url 'dashboard:lost_and_found_export' %}?" + params.toString();
        });
    }
</script>
{% endblock extra_js %}
