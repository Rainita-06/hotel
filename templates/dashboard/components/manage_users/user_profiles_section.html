{% load static dict_extras %}

<section id="user_profiles" class="mt-8">
  <div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8 space-y-8">

    <!-- Role Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Dynamic Role Cards -->
      {% for group in groups %}
      <div class="bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
        <div class="p-4 flex items-start justify-between">
          <div class="flex items-center gap-3">
            <span class="inline-flex h-12 w-12 items-center justify-center rounded-lg {% if 'admin' in group.name|lower %}bg-red-500/10{% elif 'staff' in group.name|lower %}bg-teal-500/10{% else %}bg-sky-600/10{% endif %}">
              <span class="block h-6 w-6 rounded {% if 'admin' in group.name|lower %}bg-red-500{% elif 'staff' in group.name|lower %}bg-teal-500{% else %}bg-sky-600{% endif %}"></span>
            </span>
            <div>
              <h3 class="text-lg font-semibold text-gray-900">{{ group.name }}</h3>
              <p class="text-sm text-gray-600">
                {% if group.name == "Admins" %}
                  Full access to all system features and settings
                {% elif group.name == "Staff" %}
                  Access to operational features and guest services
                {% else %}
                  Basic access to guest-facing features only
                {% endif %}
              </p>
            </div>
          </div>
          <div class="flex items-center gap-1">
            <!-- Only show action buttons if user has appropriate permissions -->
            {% if 'manage_users' in user_permissions or 'manage_groups' in user_permissions or request.user.is_superuser %}
            <button class="p-2 rounded-lg hover:bg-gray-100" title="Copy role" onclick="copyRole({{ group.id }})">
              <img src="{% static 'images/manage_users/profiles/copy.svg' %}" alt="Copy" class="h-5 w-5">
            </button>
            <button class="p-2 rounded-lg hover:bg-gray-100" title="Edit role" onclick="window.openEditPermissionsModal({{ group.id }}, '{{ group.name|escapejs }}')">
  <img src="{% static 'images/manage_users/profiles/edit.svg' %}" alt="Edit" class="h-5 w-5">
</button>
            {% endif %}
          </div>
        </div>
        <div class="px-4 pb-4">
          <ul class="space-y-3" id="permissions-list-{{ group.id }}">
            <!-- Permissions will be loaded dynamically -->
            <li class="flex items-center justify-between text-sm text-gray-700">
              <span>Loading permissions...</span>
            </li>
          </ul>
          <div class="mt-4 flex items-center justify-between">
            <p class="text-sm text-gray-600">{{ group_user_counts|get_item:group.name|default:0 }} users assigned</p>
            <span class="inline-flex items-center rounded-full bg-green-50 px-2.5 py-1 text-xs font-medium text-green-600">Active</span>
          </div>
        </div>
      </div>
      {% empty %}
      <div class="col-span-full text-center py-8">
        <p class="text-gray-500">No user groups found.</p>
      </div>
      {% endfor %}
    </div>

    <!-- Module Permissions Overview -->
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 border-b border-gray-200 px-6 py-5">
        <div>
          <h3 class="text-lg font-semibold text-gray-900">Module Permissions Overview</h3>
          <p class="text-sm text-gray-600">Compare permissions across different role templates</p>
        </div>
        <div class="flex items-center gap-3">
          <!-- Only show action buttons if user has appropriate permissions -->
          {% if 'manage_users' in user_permissions or 'manage_groups' in user_permissions or request.user.is_superuser %}
          <button class="inline-flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50" onclick="exportPermissions()">
            <img src="{% static 'images/manage_users/profiles/export.svg' %}" alt="Export" class="h-5 w-5">
            <span>Export</span>
          </button>
          <button class="inline-flex items-center gap-2 rounded-lg bg-sky-600 px-3 py-2 text-sm font-medium text-white hover:bg-sky-700" onclick="window.openBulkEditPermissionsModal()">
            <img src="{% static 'images/manage_users/profiles/bulk_edit.svg' %}" alt="Bulk edit" class="h-5 w-5">
            <span>Bulk Edit</span>
          </button>
          {% endif %}
        </div>
      </div>

      <div class="px-6 py-5">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Module</th>
                {% for group in groups %}
                <th scope="col" class="px-4 py-3 text-center text-sm font-semibold text-gray-900">{{ group.name }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
              <!-- Guest Requests -->
              <tr>
                <td class="px-4 py-3 text-sm text-gray-900 font-medium">Guest Requests</td>
                {% for group in groups %}
                <td class="px-4 py-3 text-center">
                  <span class="inline-flex h-5 w-5 items-center justify-center rounded-full {% if group.name == 'Admins' or group.name == 'Staff' %}bg-green-500{% else %}bg-gray-300{% endif %}">
                    {% if group.name == 'Admins' or group.name == 'Staff' %}
                    <img src="{% static 'images/manage_users/profiles/tick.svg' %}" alt="Full access" class="h-3 w-3">
                    {% else %}
                    <img src="{% static 'images/manage_users/profiles/cross.svg' %}" alt="No access" class="h-3 w-3">
                    {% endif %}
                  </span>
                </td>
                {% endfor %}
              </tr>

              <!-- Messaging System -->
              <tr>
                <td class="px-4 py-3 text-sm text-gray-900 font-medium">Messaging System</td>
                {% for group in groups %}
                <td class="px-4 py-3 text-center">
                  <span class="inline-flex h-5 w-5 items-center justify-center rounded-full {% if group.name == 'Admins' or group.name == 'Staff' %}bg-green-500{% else %}bg-gray-300{% endif %}">
                    {% if group.name == 'Admins' or group.name == 'Staff' %}
                    <img src="{% static 'images/manage_users/profiles/tick.svg' %}" alt="Full access" class="h-3 w-3">
                    {% else %}
                    <img src="{% static 'images/manage_users/profiles/cross.svg' %}" alt="No access" class="h-3 w-3">
                    {% endif %}
                  </span>
                </td>
                {% endfor %}
              </tr>

              <!-- Reports & Analytics -->
              <tr>
                <td class="px-4 py-3 text-sm text-gray-900 font-medium">Reports &amp; Analytics</td>
                {% for group in groups %}
                <td class="px-4 py-3 text-center">
                  <span class="inline-flex h-5 w-5 items-center justify-center rounded-full {% if group.name == 'Admins' %}bg-green-500{% else %}bg-gray-300{% endif %}">
                    {% if group.name == 'Admins' %}
                    <img src="{% static 'images/manage_users/profiles/tick.svg' %}" alt="Full access" class="h-3 w-3">
                    {% else %}
                    <img src="{% static 'images/manage_users/profiles/cross.svg' %}" alt="No access" class="h-3 w-3">
                    {% endif %}
                  </span>
                </td>
                {% endfor %}
              </tr>

              <!-- User Management -->
              <tr>
                <td class="px-4 py-3 text-sm text-gray-900 font-medium">User Management</td>
                {% for group in groups %}
                <td class="px-4 py-3 text-center">
                  <span class="inline-flex h-5 w-5 items-center justify-center rounded-full {% if group.name == 'Admins' %}bg-green-500{% else %}bg-gray-300{% endif %}">
                    {% if group.name == 'Admins' %}
                    <img src="{% static 'images/manage_users/profiles/tick.svg' %}" alt="Full access" class="h-3 w-3">
                    {% else %}
                    <img src="{% static 'images/manage_users/profiles/cross.svg' %}" alt="No access" class="h-3 w-3">
                    {% endif %}
                  </span>
                </td>
                {% endfor %}
              </tr>

              <!-- System Settings -->
              <tr>
                <td class="px-4 py-3 text-sm text-gray-900 font-medium">System Settings</td>
                {% for group in groups %}
                <td class="px-4 py-3 text-center">
                  <span class="inline-flex h-5 w-5 items-center justify-center rounded-full {% if group.name == 'Admins' %}bg-green-500{% else %}bg-gray-300{% endif %}">
                    {% if group.name == 'Admins' %}
                    <img src="{% static 'images/manage_users/profiles/tick.svg' %}" alt="Full access" class="h-3 w-3">
                    {% else %}
                    <img src="{% static 'images/manage_users/profiles/cross.svg' %}" alt="No access" class="h-3 w-3">
                    {% endif %}
                  </span>
                </td>
                {% endfor %}
              </tr>
              
              <!-- SLA Configuration -->
              <tr>
                <td class="px-4 py-3 text-sm text-gray-900 font-medium">SLA Configuration</td>
                {% for group in groups %}
                <td class="px-4 py-3 text-center">
                  <span class="inline-flex h-5 w-5 items-center justify-center rounded-full {% if group.name == 'Admins' %}bg-green-500{% else %}bg-gray-300{% endif %}">
                    {% if group.name == 'Admins' %}
                    <img src="{% static 'images/manage_users/profiles/tick.svg' %}" alt="Full access" class="h-3 w-3">
                    {% else %}
                    <img src="{% static 'images/manage_users/profiles/cross.svg' %}" alt="No access" class="h-3 w-3">
                    {% endif %}
                  </span>
                </td>
                {% endfor %}
              </tr>
              
              <!-- Gym Management -->
              <tr>
                <td class="px-4 py-3 text-sm text-gray-900 font-medium">Gym Management</td>
                {% for group in groups %}
                <td class="px-4 py-3 text-center">
                  <span class="inline-flex h-5 w-5 items-center justify-center rounded-full {% if group.name == 'Admins' or group.name == 'Staff' %}bg-green-500{% else %}bg-gray-300{% endif %}">
                    {% if group.name == 'Admins' or group.name == 'Staff' %}
                    <img src="{% static 'images/manage_users/profiles/tick.svg' %}" alt="Full access" class="h-3 w-3">
                    {% else %}
                    <img src="{% static 'images/manage_users/profiles/cross.svg' %}" alt="No access" class="h-3 w-3">
                    {% endif %}
                  </span>
                </td>
                {% endfor %}
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Legend -->
        <div class="mt-4 flex flex-wrap items-center gap-6 text-sm text-gray-600">
          <div class="flex items-center gap-2">
            <span class="inline-flex h-4 w-4 items-center justify-center rounded-full bg-green-500">
              <img src="{% static 'images/manage_users/profiles/tick.svg' %}" alt="" class="h-2.5 w-2.5">
            </span>
            <span>Full Access</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="inline-flex h-4 w-4 items-center justify-center rounded-full bg-yellow-400">
              <img src="{% static 'images/manage_users/profiles/eye.svg' %}" alt="" class="h-2.5 w-2.5">
            </span>
            <span>View Only</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="inline-flex h-4 w-4 items-center justify-center rounded-full bg-gray-300">
              <img src="{% static 'images/manage_users/profiles/cross.svg' %}" alt="" class="h-2.5 w-2.5">
            </span>
            <span>No Access</span>
          </div>
        </div>
      </div>
    </div>

  </div>
</section>

<script>
// Load permissions for each group
document.addEventListener('DOMContentLoaded', function() {
  {% for group in groups %}
  // Show loading state
  const permissionsList{{ group.id }} = document.getElementById('permissions-list-{{ group.id }}');
  if (permissionsList{{ group.id }}) {
    permissionsList{{ group.id }}.innerHTML = '<li class="flex items-center justify-between text-sm text-gray-700"><span>Loading permissions...</span></li>';
  }
  
  fetch('{% url "dashboard:api_group_permissions" group.id %}')
    .then(response => response.json())
    .then(data => {
      const permissionsList = document.getElementById('permissions-list-{{ group.id }}');
      if (data.permissions && data.permissions.length > 0) {
        permissionsList.innerHTML = '';
        // Show only first 4 permissions
        data.permissions.slice(0, 4).forEach(permission => {
          const li = document.createElement('li');
          li.className = 'flex items-center justify-between text-sm text-gray-700';
          li.innerHTML = `
            <span>${permission}</span>
            <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-green-500">
              <img src="{% static 'images/manage_users/profiles/tick.svg' %}" alt="Full access" class="h-3 w-3">
            </span>
          `;
          permissionsList.appendChild(li);
        });
        
        // Add "View all permissions" link if there are more than 4 permissions
        if (data.permissions.length > 4) {
          const li = document.createElement('li');
          li.className = 'flex items-center justify-center text-sm text-sky-600 mt-2';
          // Use escapejs on group name to avoid breaking the onclick string if it contains quotes
          li.innerHTML = `<button class="text-sky-600 hover:underline" onclick="window.openEditPermissionsModal({{ group.id }}, '{{ group.name|escapejs }}')">View all permissions</button>`;
          permissionsList.appendChild(li);
        }
      } else {
        permissionsList.innerHTML = '<li class="flex items-center justify-between text-sm text-gray-700"><span>No permissions defined</span></li>';
      }
    })
    .catch(error => {
      console.error('Error loading permissions for group {{ group.id }}:', error);
      const permissionsList = document.getElementById('permissions-list-{{ group.id }}');
      permissionsList.innerHTML = '<li class="flex items-center justify-between text-sm text-gray-700"><span>Failed to load permissions</span></li>';
    });
  {% endfor %}
  
  // Set up form submission handlers via safe wrappers (in case handlers are defined later)
  const editForm = document.getElementById('editPermissionsForm');
  if (editForm) {
    editForm.addEventListener('submit', function(e) {
      if (typeof window.handleEditPermissionsSubmit === 'function') {
        return window.handleEditPermissionsSubmit(e);
      }
      // If handler isn't ready yet, prevent default and retry shortly
      e.preventDefault();
      console.warn('handleEditPermissionsSubmit not available yet, retrying...');
      setTimeout(() => editForm.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true })), 200);
    });
  }

  const bulkForm = document.getElementById('bulkEditPermissionsForm');
  if (bulkForm) {
    bulkForm.addEventListener('submit', function(e) {
      if (typeof window.handleBulkEditPermissionsSubmit === 'function') {
        return window.handleBulkEditPermissionsSubmit(e);
      }
      e.preventDefault();
      console.warn('handleBulkEditPermissionsSubmit not available yet, retrying...');
      setTimeout(() => bulkForm.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true })), 200);
    });
  }
});

// Icon functionality functions
function copyRole(groupId) {
  alert(`Role from group ${groupId} copied to clipboard. You can now paste it to create a new role.`);
}

function exportPermissions() {
  alert('Permissions exported successfully!');
}

</script>