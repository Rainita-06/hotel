{% load static %}
<div class="w-full max-w-[1136px] mx-auto h-80 relative bg-gradient-to-br from-white to-purple-50 rounded-xl shadow-lg outline outline-1 outline-offset-[-1px] outline-gray-200 p-6">
  <div class="w-full flex justify-between items-center mb-2">
    <div class="text-gray-900 text-lg font-semibold font-['Inter']">Department Performance Dashboard</div>
    <div class="flex items-center gap-2">
      <span class="text-gray-600 text-sm">Total Active:</span>
      <span class="text-sky-600 text-sm font-bold">{{ active_tickets }} tickets</span>
    </div>
  </div>

  <!-- Chart area -->
  <div class="h-[calc(100%-48px)] flex items-center">
    <canvas id="departmentBarChart" class="w-full h-full"></canvas>
  </div>
</div>

<!-- ChartJS CDN (lightweight) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  (function() {
    // Parse JSON strings passed from view (they are JSON arrays)
    const labels = {{ dept_labels|default:"[]"|safe }};
    const assigned = {{ dept_assigned_counts|default:"[]"|safe }};
    const completed = {{ dept_completed_counts|default:"[]"|safe }};

    // Only render if canvas exists and we have labels
    const ctx = document.getElementById('departmentBarChart');
    if (!ctx || !labels.length) return;

    // Destroy previous chart instance if exists (avoid duplication if partial reloads used)
    if (window._deptBarChart instanceof Chart) {
      window._deptBarChart.destroy();
    }

    window._deptBarChart = new Chart(ctx.getContext('2d'), {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Assigned / Open',
            data: assigned,
            backgroundColor: 'rgba(59,130,246,0.9)', // blue
            borderColor: 'rgba(59,130,246,1)',
            borderWidth: 1
          },
          {
            label: 'Completed',
            data: completed,
            backgroundColor: 'rgba(34,197,94,0.9)', // green
            borderColor: 'rgba(34,197,94,1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        maintainAspectRatio: false,
        responsive: true,
        plugins: {
          legend: {
            position: 'top',
          },
          tooltip: {
            mode: 'index',
            intersect: false
          }
        },
        scales: {
          x: {
            stacked: false,
            grid: { display: false }
          },
          y: {
            beginAtZero: true,
            ticks: {
              // force integers
              callback: function(value) { if (Number.isInteger(value)) return value; return null; }
            },
            grid: { display: true, color: 'rgba(0,0,0,0.04)' }
          }
        }
      }
    });
  })();
</script>
