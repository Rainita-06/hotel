{% extends "dashboard/base_dashboard.html" %}

{% block title %}Voucher Detail - {{ voucher.voucher_code }}{% endblock %}

{% block dashboard_content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h1 class="page-title">
                    <i class="fas fa-ticket-alt me-3"></i>Voucher Details
                </h1>
                <p class="page-subtitle">Voucher Code: <code class="fs-5">{{ voucher.voucher_code }}</code></p>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'dashboard:voucher_analytics' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Analytics
                </a>
                {% if voucher.qr_image %}
                <button class="btn btn-primary" onclick="showQRFullscreen()">
                    <i class="fas fa-expand me-2"></i>View QR Fullscreen
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Voucher Information -->
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>Voucher Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="info-group">
                                <label class="fw-semibold text-muted mb-1">Voucher Code</label>
                                <p class="fs-5"><code>{{ voucher.voucher_code }}</code></p>
                            </div>
                            
                            <div class="info-group">
                                <label class="fw-semibold text-muted mb-1">Type</label>
                                <p><span class="badge bg-primary fs-6">{{ voucher.voucher_type|title }}</span></p>
                            </div>
                            
                            <div class="info-group">
                                <label class="fw-semibold text-muted mb-1">Status</label>
                                <p>
                                    {% if voucher.status == 'active' %}
                                        <span class="badge bg-success fs-6">{{ voucher.status|title }}</span>
                                    {% elif voucher.status == 'redeemed' %}
                                        <span class="badge bg-info fs-6">{{ voucher.status|title }}</span>
                                    {% elif voucher.status == 'expired' %}
                                        <span class="badge bg-danger fs-6">{{ voucher.status|title }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary fs-6">{{ voucher.status|title }}</span>
                                    {% endif %}
                                </p>
                            </div>
                            
                            <div class="info-group">
                                <label class="fw-semibold text-muted mb-1">Created</label>
                                <p>{{ voucher.created_at|date:"M d, Y H:i" }}</p>
                            </div>
                            
                            {% if voucher.valid_dates %}
                            <div class="info-group">
                                <label class="fw-semibold text-muted mb-1">Valid Dates</label>
                                <div class="d-flex flex-wrap gap-1">
                                    {% for date in voucher.valid_dates %}
                                        {% if date in voucher.scan_history %}
                                            <span class="badge bg-success">{{ date }} ✓</span>
                                        {% else %}
                                            <span class="badge bg-outline-primary">{{ date }}</span>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            {% if voucher.guest %}
                                <div class="info-group">
                                    <label class="fw-semibold text-muted mb-1">Guest</label>
                                    <p class="fw-semibold">{{ voucher.guest.full_name }}</p>
                                </div>
                                
                                <div class="info-group">
                                    <label class="fw-semibold text-muted mb-1">Room</label>
                                    <p>{{ voucher.guest.room_number|default:"N/A" }}</p>
                                </div>
                                
                                <div class="info-group">
                                    <label class="fw-semibold text-muted mb-1">Email</label>
                                    <p>{{ voucher.guest.email|default:"N/A" }}</p>
                                </div>
                                
                                <div class="info-group">
                                    <label class="fw-semibold text-muted mb-1">Phone</label>
                                    <p>{{ voucher.guest.phone|default:"N/A" }}</p>
                                </div>
                            {% else %}
                                <div class="info-group">
                                    <label class="fw-semibold text-muted mb-1">Guest</label>
                                    <p class="text-muted">Not assigned</p>
                                </div>
                            {% endif %}
                            
                            {% if voucher.check_in_date and voucher.check_out_date %}
                            <div class="info-group">
                                <label class="fw-semibold text-muted mb-1">Stay Period</label>
                                <p>{{ voucher.check_in_date|date:"M d, Y" }} - {{ voucher.check_out_date|date:"M d, Y" }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- QR Code & Actions -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-qrcode me-2"></i>QR Code & Actions
                    </h5>
                </div>
                <div class="card-body text-center">
                    {% if voucher.qr_image %}
                        <div class="qr-display mb-4">
                            <img id="qrModalImage" src="data:image/png;base64,{{ voucher.qr_image }}" alt="QR Code" 
                                 class="img-fluid border rounded-3" 
                                 style="width: 100%; height: 250px; object-fit: contain; background: white; padding: 15px; cursor: pointer; border: 2px solid #e9ecef;"
                                 onclick="showQRFullscreen()">
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="showQRFullscreen()">
                                <i class="fas fa-expand me-2"></i>View Fullscreen
                            </button>
                            
                            <a href="data:image/png;base64,{{ voucher.qr_image }}" 
                               download="voucher_{{ voucher.voucher_code }}.png" 
                               class="btn btn-success">
                                <i class="fas fa-download me-2"></i>Download QR
                            </a>
                            
                            {% if voucher.guest and voucher.guest.phone %}
                            <button class="btn btn-warning" onclick="shareVoucherWhatsApp()">
                                <i class="fab fa-whatsapp me-2"></i>Share via WhatsApp
                            </button>
                            {% endif %}
                            
                            <button class="btn btn-info" onclick="copyVoucherCode()">
                                <i class="fas fa-copy me-2"></i>Copy Voucher Code
                            </button>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-qrcode fa-4x text-muted mb-3"></i>
                            <p class="text-muted mb-3">No QR code available</p>
                            <form method="post" action="{% url 'dashboard:regenerate_voucher_qr' voucher.id %}" data-toast="true">
                                {% csrf_token %}
                                <input type="hidden" name="qr_size" value="xxlarge">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-qrcode me-2"></i>Generate QR Code
                                </button>
                            </form>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Scan History -->
    {% if scans %}
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-history me-2"></i>Scan History
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Date & Time</th>
                            <th>Scanned By</th>
                            <th>Result</th>
                            <th>Source</th>
                            <th>IP Address</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for scan in scans %}
                        <tr>
                            <td>{{ scan.scanned_at|date:"M d, Y H:i:s" }}</td>
                            <td>
                                {% if scan.scanned_by %}
                                    {{ scan.scanned_by.get_full_name|default:scan.scanned_by.username }}
                                {% else %}
                                    <span class="text-muted">System</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if scan.redemption_successful %}
                                    <span class="badge bg-success">Success</span>
                                {% else %}
                                    <span class="badge bg-danger">{{ scan.scan_result|title }}</span>
                                {% endif %}
                            </td>
                            <td>{{ scan.scan_source|default:"Web"|title }}</td>
                            <td class="text-muted">{{ scan.ip_address|default:"-" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- QR Code Fullscreen Modal -->
<div class="modal fade" id="qrFullscreenModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">Voucher QR Code - {{ voucher.voucher_code }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-5" style="background: white;">
                {% if voucher.qr_image %}
                    <img src="data:image/png;base64,{{ voucher.qr_image }}" alt="QR Code" 
                         class="img-fluid border rounded-3" 
                         style="max-width: 100%; max-height: 500px; background: white; padding: 20px;">
                    <div class="mt-4">
                        <p class="text-muted mb-2">Scan this QR code with any QR scanner or camera app</p>
                        <p class="fw-semibold">Voucher: <code>{{ voucher.voucher_code }}</code></p>
                        {% if voucher.guest %}
                            <p class="text-muted">Guest: {{ voucher.guest.full_name }}</p>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <a href="data:image/png;base64,{{ voucher.qr_image }}" 
                   download="voucher_{{ voucher.voucher_code }}.png" 
                   class="btn btn-success">
                    <i class="fas fa-download me-2"></i>Download QR Code
                </a>
                {% if voucher.guest and voucher.guest.phone %}
                <button type="button" class="btn btn-warning" onclick="shareVoucherWhatsApp()">
                    <i class="fab fa-whatsapp me-2"></i>Share via WhatsApp
                </button>
                {% endif %}
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// QR Fullscreen Modal
function showQRFullscreen() {
    const modal = new bootstrap.Modal(document.getElementById('qrFullscreenModal'));
    modal.show();
}

// Copy Voucher Code
function copyVoucherCode() {
    const code = '{{ voucher.voucher_code }}';
    navigator.clipboard.writeText(code).then(() => {
        showSuccess('Voucher code copied to clipboard!');
    }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = code;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showSuccess('Voucher code copied to clipboard!');
    });
}

// WhatsApp Sharing
function shareVoucherWhatsApp() {
    {% if voucher.guest and voucher.guest.phone %}
        const btn = event.target;
        showLoading(btn, 'Preparing...');
        
        // Try WhatsApp Business API first
        fetch('{% url "dashboard:share_voucher_whatsapp" voucher.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            hideLoading(btn);
            
            if (data.success) {
                showSuccess(data.message);
            } else {
                // Fallback to wa.me URL
                return fallbackWhatsAppShare();
            }
        })
        .catch(error => {
            hideLoading(btn);
            console.error('WhatsApp API Error:', error);
            // Fallback to wa.me URL
            return fallbackWhatsAppShare();
        });
    {% else %}
        showWarning('No phone number available for this guest.');
    {% endif %}
}

function fallbackWhatsAppShare() {
    // Create formatted message
    const message = `🏨 Hotel Voucher - {{ voucher.voucher_type|title }}\n\n` +
                   `Dear {{ voucher.guest_name|default:"Guest" }},\n\n` +
                   `Your {{ voucher.voucher_type }} voucher is ready!\n\n` +
                   `📋 Voucher Details:\n` +
                   `• Guest: {{ voucher.guest_name|default:"N/A" }}\n` +
                   `• Room: {{ voucher.room_number|default:"N/A" }}\n` +
                   `{% if voucher.valid_dates %}• Valid Dates: {{ voucher.valid_dates|join:", " }}\n{% endif %}` +
                   `• Voucher Code: {{ voucher.voucher_code }}\n\n` +
                   `📱 Show this QR code at the restaurant/service location.\n\n` +
                   `Thank you for staying with us! 🌟`;
    
    const phone = '{{ voucher.guest.phone|default:"" }}'.replace(/[^0-9]/g, '');
    const waUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
    
    window.open(waUrl, '_blank');
    showInfo('WhatsApp opened with voucher details. The QR code image needs to be shared separately.');
}

// Auto-generate QR if missing
{% if not voucher.qr_image %}
    document.addEventListener('DOMContentLoaded', function() {
        showWarning('This voucher doesn\'t have a QR code. Click "Generate QR Code" to create one.');
    });
{% endif %}
</script>
{% endblock %}
