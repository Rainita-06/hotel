{% extends "dashboard/base_dashboard.html" %} {% block dashboard_content %}
<!-- Breadcrumb Navigation -->
<nav aria-label="breadcrumb" class="mb-4">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">
      <a href="{% url 'dashboard:main' %}">Dashboard</a>
    </li>
    <li class="breadcrumb-item">
      <a href="{% url 'dashboard:guests' %}">Guests</a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">
      {{ guest.full_name|default:"Guest Details" }}
    </li>
  </ol>
</nav>

<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="fw-bold">
    <i class="bi bi-person-circle text-primary"></i>
    Guest Details
  </h2>
  <div class="btn-group" role="group">
    <a href="{% url 'dashboard:guests' %}" class="btn btn-secondary">
      <i class="bi bi-arrow-left"></i> Back to Guests
    </a>
    <button
      type="button"
      class="btn btn-primary dropdown-toggle"
      data-bs-toggle="dropdown"
    >
      <i class="bi bi-gear"></i> Actions
    </button>
    <ul class="dropdown-menu">
      <li>
        <a class="dropdown-item" href="#"
          ><i class="bi bi-pencil"></i> Edit Guest</a
        >
      </li>
      <li>
        <a class="dropdown-item" href="#"
          ><i class="bi bi-ticket"></i> Issue Voucher</a
        >
      </li>
      <li><hr class="dropdown-divider" /></li>
      <li>
        <a class="dropdown-item text-danger" href="#"
          ><i class="bi bi-trash"></i> Delete Guest</a
        >
      </li>
    </ul>
  </div>
</div>

<!-- Guest Information Card -->
<div class="row mb-4">
  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">
        <h5 class="card-title mb-0">
          <i class="bi bi-person-badge"></i> Guest Information
        </h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <dl class="row">
              <dt class="col-sm-4">Full Name:</dt>
              <dd class="col-sm-8">
                {{ guest.full_name|default:"Not provided" }}
              </dd>

              <dt class="col-sm-4">Guest ID:</dt>
              <dd class="col-sm-8">
                <span class="badge bg-secondary"
                  >{{ guest.guest_id|default:"Auto-generated" }}</span
                >
              </dd>

              <dt class="col-sm-4">Email:</dt>
              <dd class="col-sm-8">
                {% if guest.email %}
                <a href="mailto:{{ guest.email }}">{{ guest.email }}</a>
                {% else %}
                <span class="text-muted">Not provided</span>
                {% endif %}
              </dd>

              <dt class="col-sm-4">Phone:</dt>
              <dd class="col-sm-8">
                {% if guest.phone %}
                <a href="tel:{{ guest.phone }}">{{ guest.phone }}</a>
                {% else %}
                <span class="text-muted">Not provided</span>
                {% endif %}
              </dd>
            </dl>
          </div>
          <div class="col-md-6">
            <dl class="row">
              <dt class="col-sm-4">Room:</dt>
              <dd class="col-sm-8">
                <span class="badge bg-info fs-6"
                  >{{ guest.room_number|default:"Not assigned" }}</span
                >
              </dd>

              <dt class="col-sm-4">Check-in:</dt>
              <dd class="col-sm-8">
                {% if guest.checkin_date %} {{ guest.checkin_date|date:"M d, Y"
                }} {% else %}
                <span class="text-muted">Not set</span>
                {% endif %}
              </dd>

              <dt class="col-sm-4">Check-out:</dt>
              <dd class="col-sm-8">
                {% if guest.checkout_date %} {{ guest.checkout_date|date:"M d,
                Y" }} {% else %}
                <span class="text-muted">Not set</span>
                {% endif %}
              </dd>

              <dt class="col-sm-4">Breakfast:</dt>
              <dd class="col-sm-8">
                {% if guest.breakfast_included %}
                <span class="badge bg-success">Included</span>
                {% else %}
                <span class="badge bg-secondary">Not Included</span>
                {% endif %}
              </dd>
            </dl>
          </div>
        </div>
        {% if guest.package_type %}
        <div class="row mt-3">
          <div class="col-12">
            <dt>Package Type:</dt>
            <dd>
              <span class="badge bg-warning text-dark"
                >{{ guest.package_type }}</span
              >
            </dd>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Quick Stats -->
  <div class="col-lg-4">
    <div class="card shadow-sm">
      <div class="card-header bg-success text-white">
        <h5 class="card-title mb-0">
          <i class="bi bi-graph-up"></i> Quick Stats
        </h5>
      </div>
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <span>Total Vouchers:</span>
          <span class="badge bg-primary fs-6">{{ vouchers.count }}</span>
        </div>
        <div class="d-flex justify-content-between align-items-center mb-3">
          <span>Active Vouchers:</span>
          <span class="badge bg-success fs-6">{{ vouchers|length }}</span>
        </div>
        <div class="d-flex justify-content-between align-items-center mb-3">
          <span>Stay Duration:</span>
          <span class="badge bg-info fs-6">
            {% if guest.checkin_date and guest.checkout_date %} {{
            guest.checkout_date|timeuntil:guest.checkin_date }} {% else %} N/A
            {% endif %}
          </span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Vouchers Section -->
<div class="card shadow-sm">
  <div
    class="card-header bg-warning text-dark d-flex justify-content-between align-items-center"
  >
    <h5 class="card-title mb-0">
      <i class="bi bi-ticket-perforated"></i> Vouchers ({{ vouchers.count }})
    </h5>
    <button class="btn btn-sm btn-primary">
      <i class="bi bi-plus-circle"></i> Issue New Voucher
    </button>
  </div>
  <div class="card-body">
    {% if vouchers %}
    <div class="table-responsive">
      <table class="table table-hover">
        <thead class="table-light">
          <tr>
            <th>Code</th>
            <th>Type</th>
            <th>Status</th>
            <th>Valid From</th>
            <th>Valid To</th>
            <th>Quantity</th>
            <th>QR Code</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for voucher in vouchers %}
          <tr>
            <td>
              <code class="bg-light p-1 rounded"
                >{{ voucher.voucher_code }}</code
              >
            </td>
            <td>
              <span class="badge bg-info"
                >{{ voucher.get_voucher_type_display }}</span
              >
            </td>
            <td>
              {% if voucher.status == 'active' %}
              <span class="badge bg-success"
                >{{ voucher.get_status_display }}</span
              >
              {% elif voucher.status == 'redeemed' %}
              <span class="badge bg-primary"
                >{{ voucher.get_status_display }}</span
              >
              {% elif voucher.status == 'expired' %}
              <span class="badge bg-warning"
                >{{ voucher.get_status_display }}</span
              >
              {% else %}
              <span class="badge bg-secondary"
                >{{ voucher.get_status_display }}</span
              >
              {% endif %}
            </td>
            <td>
              {% if voucher.valid_from %} {{ voucher.valid_from|date:"M d, Y" }}
              {% else %}
              <span class="text-muted">Not set</span>
              {% endif %}
            </td>
            <td>
              {% if voucher.valid_to %} {{ voucher.valid_to|date:"M d, Y" }} {%
              else %}
              <span class="text-muted">Not set</span>
              {% endif %}
            </td>
            <td>
              <span class="badge bg-secondary">{{ voucher.quantity }}</span>
            </td>
            <td>
              {% if voucher.qr_image %}
              <button
                class="btn btn-sm btn-outline-primary"
                data-bs-toggle="modal"
                data-bs-target="#qrModal{{ voucher.id }}"
              >
                <i class="bi bi-qr-code"></i> View QR
              </button>
              {% else %}
              <span class="text-muted">No QR</span>
              {% endif %}
            </td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <a
                  href="{% url 'dashboard:voucher_detail' voucher.id %}"
                  class="btn btn-outline-primary"
                >
                  <i class="bi bi-eye"></i>
                </a>
                <button class="btn btn-outline-warning">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-danger">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>

          <!-- QR Code Modal for each voucher -->
          {% if voucher.qr_image %}
          <div class="modal fade" id="qrModal{{ voucher.id }}" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">
                    QR Code - {{ voucher.voucher_code }}
                  </h5>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                  ></button>
                </div>
                <div class="modal-body text-center">
                  <img
                    src="{{ voucher.qr_image.url }}"
                    alt="QR Code"
                    class="img-fluid border rounded"
                    style="max-width: 300px"
                  />
                  <p class="mt-3 text-muted">
                    {{ voucher.get_voucher_type_display }} - {{
                    voucher.get_status_display }}
                  </p>
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                  >
                    Close
                  </button>
                  <a
                    href="{{ voucher.qr_image.url }}"
                    download
                    class="btn btn-primary"
                  >
                    <i class="bi bi-download"></i> Download
                  </a>
                </div>
              </div>
            </div>
          </div>
          {% endif %} {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="text-center py-5">
      <div class="text-muted">
        <i class="bi bi-ticket-perforated fs-1"></i>
        <p class="mt-3">No vouchers issued for this guest yet.</p>
        <button class="btn btn-primary">
          <i class="bi bi-plus-circle"></i> Issue First Voucher
        </button>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Timeline/Activity Section -->
<div class="card shadow-sm mt-4">
  <div class="card-header bg-info text-white">
    <h5 class="card-title mb-0">
      <i class="bi bi-clock-history"></i> Recent Activity
    </h5>
  </div>
  <div class="card-body">
    <div class="timeline">
      <div class="timeline-item">
        <div class="timeline-marker bg-success"></div>
        <div class="timeline-content">
          <h6 class="timeline-title">Guest Registered</h6>
          <p class="timeline-text text-muted">
            {{ guest.created_at|date:"M d, Y \a\t g:i A" }}
          </p>
        </div>
      </div>
      {% for voucher in vouchers|slice:":3" %}
      <div class="timeline-item">
        <div class="timeline-marker bg-primary"></div>
        <div class="timeline-content">
          <h6 class="timeline-title">Voucher Issued</h6>
          <p class="timeline-text text-muted">
            {{ voucher.get_voucher_type_display }} voucher created
          </p>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<style>
  .timeline {
    position: relative;
    padding-left: 30px;
  }

  .timeline::before {
    content: "";
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
  }

  .timeline-item {
    position: relative;
    margin-bottom: 20px;
  }

  .timeline-marker {
    position: absolute;
    left: -22px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 0 0 2px #dee2e6;
  }

  .timeline-content {
    padding-left: 15px;
  }

  .timeline-title {
    margin-bottom: 5px;
    font-weight: 600;
  }

  .timeline-text {
    margin-bottom: 0;
    font-size: 0.9rem;
  }
</style>
{% endblock dashboard_content %}
