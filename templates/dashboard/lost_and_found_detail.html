{% extends "dashboard/base_dashboard.html" %}
{% load static %}
{% load dashboard2_extras %}

{% block extra_css %}
<style>
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.375rem 0.875rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .status-open { background: #fef3c7; color: #92400e; }
    .status-found { background: #dbeafe; color: #1e40af; }
    .status-returned { background: #d1fae5; color: #065f46; }
    
    .priority-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .priority-low { background: #e5e7eb; color: #374151; }
    .priority-normal { background: #dbeafe; color: #1e40af; }
    .priority-high { background: #fed7aa; color: #9a3412; }
    .priority-urgent { background: #fecaca; color: #991b1b; }
    
    .type-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .type-guest_left { background: #fae8ff; color: #86198f; }
    .type-guest_lost { background: #ffedd5; color: #9a3412; }
    .type-staff_found { background: #dcfce7; color: #166534; }
    
    .info-card {
        background: white;
        border-radius: 0.75rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
    }
    
    .detail-row {
        display: flex;
        align-items: flex-start;
        padding: 0.75rem 0;
        border-bottom: 1px solid #f3f4f6;
    }
    
    .detail-row:last-child {
        border-bottom: none;
    }
    
    .detail-label {
        min-width: 140px;
        color: #6b7280;
        font-size: 0.875rem;
    }
    
    .detail-value {
        flex: 1;
        color: #111827;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .action-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.625rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s;
    }
    
    .action-btn:hover {
        transform: translateY(-1px);
    }
    
    .timeline-item {
        position: relative;
        padding-left: 2rem;
        padding-bottom: 1.5rem;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: 0.4375rem;
        top: 1.5rem;
        bottom: 0;
        width: 2px;
        background: #e5e7eb;
    }
    
    .timeline-item:last-child::before {
        display: none;
    }
    
    .timeline-dot {
        position: absolute;
        left: 0;
        top: 0.25rem;
        width: 1rem;
        height: 1rem;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 0 0 2px currentColor;
    }
    
    .timeline-dot.completed {
        background: currentColor;
    }
</style>
{% endblock extra_css %}

{% block content %}
<div class="w-full max-w-[1184px] mx-auto bg-gray-50 font-['Inter'] pb-24 lg:pb-0">

    <!-- Header -->
    <header class="w-full bg-white border-b border-gray-200 p-4 lg:p-6">
        <div class="flex justify-between items-start">
            <div class="flex items-center gap-4">
                <button onclick="window.location.href='{% url 'dashboard:lost_and_found' %}'" class="text-gray-600 hover:text-gray-800 p-2 hover:bg-gray-100 rounded-lg transition-colors" aria-label="Back to items">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <div>
                    <div class="flex items-center gap-3">
                        <h1 class="text-lg lg:text-2xl font-bold text-gray-900">{{ item.item_name }}</h1>
                        <span class="text-gray-400">#{{ item.id }}</span>
                    </div>
                    <div class="flex items-center flex-wrap gap-3 mt-2">
                        <span class="type-badge type-{{ item.item_type }}">{{ item.get_item_type_display }}</span>
                        <span class="priority-badge priority-{{ item.priority }}">{{ item.get_priority_display }} Priority</span>
                        {% if item.is_broadcast %}
                        <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-orange-700 bg-orange-100 rounded-full">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M18 3a1 1 0 00-1.196-.98l-10 2A1 1 0 006 5v9.114A4.369 4.369 0 005 14c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V7.82l8-1.6v5.894A4.37 4.37 0 0015 12c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V3z"></path>
                            </svg>
                            Broadcasted
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="status-badge status-{{ item.status }}">
                    {{ item.get_status_display }}
                </div>
            </div>
        </div>
    </header>

    <main class="p-4 lg:p-6 flex flex-col lg:flex-row gap-6">
        
        <!-- Main Content Area -->
        <div class="flex-grow flex flex-col gap-6 lg:w-2/3">

            <!-- Item Details Card -->
            <section class="info-card p-4 lg:p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                    Item Details
                </h3>
                
                <div class="space-y-0">
                    <div class="detail-row">
                        <span class="detail-label">Item Name</span>
                        <span class="detail-value">{{ item.item_name }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Category</span>
                        <span class="detail-value">{{ item.item_category|default:"Not specified" }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Item Type</span>
                        <span class="detail-value">{{ item.get_item_type_display }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Priority</span>
                        <span class="detail-value">
                            <span class="priority-badge priority-{{ item.priority }}">{{ item.get_priority_display }}</span>
                        </span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Status</span>
                        <span class="detail-value">
                            <span class="status-badge status-{{ item.status }}">{{ item.get_status_display }}</span>
                        </span>
                    </div>
                    {% if item.storage_location %}
                    <div class="detail-row">
                        <span class="detail-label">Storage Location</span>
                        <span class="detail-value">{{ item.storage_location }}</span>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Description -->
                <div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <h4 class="text-sm font-semibold text-gray-900 mb-2">Description</h4>
                    <p class="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap">{{ item.item_description|default:"No description provided." }}</p>
                </div>
                
                {% if item.resolution_notes %}
                <div class="mt-4 p-4 bg-green-50 rounded-lg border border-green-200">
                    <h4 class="text-sm font-semibold text-green-900 mb-2">Resolution Notes</h4>
                    <p class="text-sm text-green-800 leading-relaxed whitespace-pre-wrap">{{ item.resolution_notes }}</p>
                </div>
                {% endif %}
            </section>

            <!-- Location & Guest Information Card -->
            <section class="info-card p-4 lg:p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Location Section -->
                    <div>
                        <h3 class="text-base font-semibold text-gray-900 mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            Location Details
                        </h3>
                        <div class="space-y-3">
                            <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                <div class="w-10 h-10 rounded-full bg-sky-100 flex items-center justify-center">
                                    <svg class="w-5 h-5 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">
                                        {% if item.room_number %}Room {{ item.room_number }}{% else %}{{ item.found_location_description|default:"Location not specified" }}{% endif %}
                                    </p>
                                    <p class="text-xs text-gray-500">Found/Reported Location</p>
                                </div>
                            </div>
                            {% if item.location and item.location.building %}
                            <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center">
                                    <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21h18M9 8h6M9 12h6M9 16h6M5 21V5a2 2 0 012-2h10a2 2 0 012 2v16"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">{{ item.location.building.name }}</p>
                                    <p class="text-xs text-gray-500">Building</p>
                                </div>
                            </div>
                            {% elif item.building %}
                            <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center">
                                    <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21h18M9 8h6M9 12h6M9 16h6M5 21V5a2 2 0 012-2h10a2 2 0 012 2v16"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">{{ item.building }}</p>
                                    <p class="text-xs text-gray-500">Building</p>
                                </div>
                            </div>
                            {% endif %}
                            {% if item.floor %}
                            <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center">
                                    <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2h9v9h-9V2zm0 12h9v9h-9v-9zM3 2h9v9H3V2zm0 12h9v9H3v-9z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">{{ item.floor }}</p>
                                    <p class="text-xs text-gray-500">Floor</p>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Guest Information Section -->
                    <div>
                        <h3 class="text-base font-semibold text-gray-900 mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            Guest Information
                        </h3>
                        {% if item.guest_name %}
                        <div class="space-y-3">
                            <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
                                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">{{ item.guest_name }}</p>
                                    <p class="text-xs text-gray-500">Guest Name</p>
                                </div>
                            </div>
                            {% if item.guest_phone %}
                            <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">{{ item.guest_phone }}</p>
                                    <p class="text-xs text-gray-500">Phone</p>
                                </div>
                            </div>
                            {% endif %}
                            {% if item.guest_email %}
                            <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center">
                                    <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">{{ item.guest_email }}</p>
                                    <p class="text-xs text-gray-500">Email</p>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="p-4 bg-gray-50 rounded-lg text-center">
                            <svg class="w-8 h-8 text-gray-300 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            <p class="text-sm text-gray-500 italic">No guest information provided</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </section>

            <!-- Timeline Card -->
            <section class="info-card p-4 lg:p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Activity Timeline
                </h3>
                
                <div class="space-y-0">
                    <!-- Reported -->
                    <div class="timeline-item text-yellow-600">
                        <div class="timeline-dot completed bg-yellow-500"></div>
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium text-gray-900">Item Reported</p>
                                <p class="text-xs text-gray-500">
                                    {% if item.reported_by %}Reported by {{ item.reported_by.get_full_name|default:item.reported_by.username }}{% endif %}
                                </p>
                            </div>
                            <span class="text-xs text-gray-500">{{ item.reported_at|date:"M d, Y H:i" }}</span>
                        </div>
                    </div>
                    
                    {% if item.accepted_at %}
                    <!-- Accepted -->
                    <div class="timeline-item text-blue-600">
                        <div class="timeline-dot completed bg-blue-500"></div>
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium text-gray-900">Task Accepted</p>
                                <p class="text-xs text-gray-500">
                                    {% if item.accepted_by %}Accepted by {{ item.accepted_by.get_full_name|default:item.accepted_by.username }}{% endif %}
                                </p>
                            </div>
                            <span class="text-xs text-gray-500">{{ item.accepted_at|date:"M d, Y H:i" }}</span>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if item.found_at %}
                    <!-- Found -->
                    <div class="timeline-item text-purple-600">
                        <div class="timeline-dot completed bg-purple-500"></div>
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium text-gray-900">Item Found</p>
                                {% if item.storage_location %}
                                <p class="text-xs text-gray-500">Stored at: {{ item.storage_location }}</p>
                                {% endif %}
                            </div>
                            <span class="text-xs text-gray-500">{{ item.found_at|date:"M d, Y H:i" }}</span>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if item.claimed_at %}
                    <!-- Claimed -->
                    <div class="timeline-item text-green-600">
                        <div class="timeline-dot completed bg-green-500"></div>
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium text-gray-900">Item Claimed</p>
                                <p class="text-xs text-gray-500">Owner claimed the item</p>
                            </div>
                            <span class="text-xs text-gray-500">{{ item.claimed_at|date:"M d, Y H:i" }}</span>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if item.returned_at %}
                    <!-- Returned -->
                    <div class="timeline-item text-cyan-600">
                        <div class="timeline-dot completed bg-cyan-500"></div>
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium text-gray-900">Item Returned</p>
                                <p class="text-xs text-gray-500">Returned to owner</p>
                            </div>
                            <span class="text-xs text-gray-500">{{ item.returned_at|date:"M d, Y H:i" }}</span>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if item.closed_at %}
                    <!-- Closed -->
                    <div class="timeline-item text-gray-600">
                        <div class="timeline-dot completed bg-gray-500"></div>
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium text-gray-900">Case Closed</p>
                                <p class="text-xs text-gray-500">Item resolved</p>
                            </div>
                            <span class="text-xs text-gray-500">{{ item.closed_at|date:"M d, Y H:i" }}</span>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if item.is_broadcast and item.broadcast_at %}
                    <!-- Broadcast -->
                    <div class="timeline-item text-orange-600">
                        <div class="timeline-dot completed bg-orange-500"></div>
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium text-gray-900">Broadcast Sent</p>
                                <p class="text-xs text-gray-500">Notification sent to all staff</p>
                            </div>
                            <span class="text-xs text-gray-500">{{ item.broadcast_at|date:"M d, Y H:i" }}</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </section>
        </div>

        <!-- Sidebar Actions -->
        <aside class="flex flex-col gap-6 lg:w-1/3">
            
            <!-- Quick Actions Card -->
            <section class="info-card p-6">
                <h3 class="text-base font-semibold text-gray-900 mb-4">Quick Actions</h3>
                <div class="space-y-3">
                    {% if not item.is_broadcast %}
                    <button id="broadcastBtn" class="action-btn w-full bg-orange-500 text-white hover:bg-orange-600" data-item-id="{{ item.id }}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15.414a5 5 0 001.414 1.414m2.828-9.9a9 9 0 0112.728 0"></path>
                        </svg>
                        Broadcast to All Staff
                    </button>
                    {% endif %}
                    
                    {% if item.status == 'open' %}
                    <button id="markFoundBtn" class="action-btn w-full bg-blue-600 text-white hover:bg-blue-700" data-item-id="{{ item.id }}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Mark as Found
                    </button>
                    {% endif %}
                    
                    {% if item.status == 'found' %}
                    <button id="markReturnedBtn" class="action-btn w-full bg-green-600 text-white hover:bg-green-700" data-item-id="{{ item.id }}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                        </svg>
                        Mark as Returned
                    </button>
                    {% endif %}
                </div>
            </section>
            
            <!-- Status Change Card -->
            <section class="info-card p-6">
                <h3 class="text-base font-semibold text-gray-900 mb-4">Change Status</h3>
                <div class="space-y-2">
                    <select id="statusSelect" class="w-full h-10 px-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 text-sm">
                        {% for value, label in status_choices %}
                        <option value="{{ value }}" {% if item.status == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                    <button id="updateStatusBtn" class="action-btn w-full bg-sky-600 text-white hover:bg-sky-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Update Status
                    </button>
                </div>
            </section>
            
            <!-- Assignment Card -->
            <section class="info-card p-6">
                <h3 class="text-base font-semibold text-gray-900 mb-4">Assignment</h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Department</label>
                        <select id="departmentSelect" class="w-full h-10 px-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 text-sm">
                            <option value="">Select Department</option>
                            {% for dept in departments %}
                            <option value="{{ dept.id }}" {% if item.assigned_department and item.assigned_department.id == dept.id %}selected{% endif %}>{{ dept.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Assigned To</label>
                        <select id="userSelect" class="w-full h-10 px-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 text-sm">
                            <option value="">Select User</option>
                            {% for user in users %}
                            <option value="{{ user.id }}" {% if item.assigned_user and item.assigned_user.id == user.id %}selected{% endif %}>{{ user.get_full_name|default:user.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button id="updateAssignmentBtn" class="action-btn w-full bg-indigo-600 text-white hover:bg-indigo-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Update Assignment
                    </button>
                </div>
                
                {% if item.assigned_department or item.assigned_user %}
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <p class="text-xs text-gray-500">Current Assignment:</p>
                    {% if item.assigned_department %}
                    <p class="text-sm text-gray-700 mt-1">Department: <strong>{{ item.assigned_department.name }}</strong></p>
                    {% endif %}
                    {% if item.assigned_user %}
                    <p class="text-sm text-gray-700 mt-1">User: <strong>{{ item.assigned_user.get_full_name|default:item.assigned_user.username }}</strong></p>
                    {% endif %}
                </div>
                {% endif %}
            </section>
            
            <!-- Item Info Card -->
            <section class="info-card p-6">
                <h3 class="text-base font-semibold text-gray-900 mb-4">Item Information</h3>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <span class="text-gray-600">Item ID</span>
                        <span class="font-medium text-gray-900">#{{ item.id }}</span>
                    </div>
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <span class="text-gray-600">Created</span>
                        <span class="font-medium text-gray-900">{{ item.reported_at|date:"M d, Y" }}</span>
                    </div>
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <span class="text-gray-600">Last Updated</span>
                        <span class="font-medium text-gray-900">{{ item.updated_at|date:"M d, Y H:i" }}</span>
                    </div>
                    {% if item.reported_by %}
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <span class="text-gray-600">Reported By</span>
                        <span class="font-medium text-gray-900">{{ item.reported_by.get_full_name|default:item.reported_by.username }}</span>
                    </div>
                    {% endif %}
                </div>
            </section>
        </aside>
    </main>
    
    <!-- Mobile Footer Actions -->
    <footer class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 p-4 lg:hidden z-50">
        <div class="grid grid-cols-2 gap-2">
            {% if item.status == 'open' %}
            <button id="markFoundBtn_mobile" class="col-span-2 action-btn bg-blue-600 text-white hover:bg-blue-700" data-item-id="{{ item.id }}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Mark Found
            </button>
            {% elif item.status == 'found' %}
            <button id="markReturnedBtn_mobile" class="col-span-2 action-btn bg-green-600 text-white hover:bg-green-700" data-item-id="{{ item.id }}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                </svg>
                Returned
            </button>
            {% endif %}
        </div>
    </footer>
</div>

<!-- Resolution Notes Modal -->
<div id="resolutionNotesModal" class="fixed inset-0 z-[1000] hidden items-center justify-center p-4 backdrop-blur-sm bg-black bg-opacity-30 transition-opacity duration-300 opacity-0" onclick="closeResolutionNotesModal()">
    <div class="w-full max-w-md rounded-lg bg-white shadow-xl transform transition-all duration-300 scale-95 opacity-0" onclick="event.stopPropagation()">
        <div class="p-6">
            <div class="flex items-start justify-between">
                <h3 class="text-lg font-semibold text-gray-900" id="modalTitle">Add Notes</h3>
                <button type="button" onclick="closeResolutionNotesModal()" class="rounded-full p-1 text-gray-500 hover:bg-gray-100 transition-colors" aria-label="Close">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="mt-4">
                <label for="resolutionNotesInput" class="block text-sm font-medium text-gray-700 mb-2">Notes (optional):</label>
                <textarea id="resolutionNotesInput" rows="4" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Add any relevant notes..."></textarea>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" onclick="closeResolutionNotesModal()" class="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-800 hover:bg-gray-50">Cancel</button>
                <button type="button" id="submitResolutionNotes" class="rounded-md bg-sky-600 px-4 py-2 text-sm font-medium text-white hover:bg-sky-700">Confirm</button>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const csrfToken = '{{ csrf_token }}';
        const itemId = "{{ item.id }}";
        
        // Helper function for API calls
        async function callApi(url, method = 'POST', body = null, useFormData = false) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                };
                
                if (body) {
                    if (useFormData) {
                        const formData = new FormData();
                        for (const key in body) {
                            formData.append(key, body[key]);
                        }
                        options.body = formData;
                    } else {
                        options.headers['Content-Type'] = 'application/json';
                        options.body = JSON.stringify(body);
                    }
                }
                
                const response = await fetch(url, options);
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message || 'Success!', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast('Error: ' + (data.error || 'Operation failed'), 'error');
                }
                return data;
            } catch (error) {
                console.error('Error:', error);
                showToast('An error occurred. Please try again.', 'error');
                return { success: false };
            }
        }
        
        // Status update with modal for notes
        let pendingStatus = null;
        let pendingModalTitle = '';
        
        function handleStatusUpdate(status, title) {
            pendingStatus = status;
            pendingModalTitle = title || 'Add Notes';
            
            document.getElementById('modalTitle').textContent = pendingModalTitle;
            
            const modal = document.getElementById('resolutionNotesModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('div').classList.remove('scale-95', 'opacity-0');
                modal.querySelector('div').classList.add('scale-100', 'opacity-100');
            }, 10);
        }
        
        window.closeResolutionNotesModal = function() {
            const modal = document.getElementById('resolutionNotesModal');
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.remove('scale-100', 'opacity-100');
            modal.querySelector('div').classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.getElementById('resolutionNotesInput').value = '';
                pendingStatus = null;
            }, 300);
        };
        
        document.getElementById('submitResolutionNotes').addEventListener('click', function() {
            const notes = document.getElementById('resolutionNotesInput').value.trim();
            closeResolutionNotesModal();
            
            if (pendingStatus) {
                const formData = new FormData();
                formData.append('action', 'update_status');
                formData.append('status', pendingStatus);
                if (notes) formData.append('notes', notes);
                
                fetch(`/dashboard/api/lost-and-found/${itemId}/update/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken },
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast(data.message || 'Status updated!', 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showToast('Error: ' + (data.error || 'Failed'), 'error');
                    }
                })
                .catch(err => {
                    console.error(err);
                    showToast('An error occurred.', 'error');
                });
            }
        });
        
        // Button Listeners
        const setupListener = (id, callback) => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('click', callback);
            const mobileEl = document.getElementById(id + '_mobile');
            if (mobileEl) mobileEl.addEventListener('click', callback);
        };
        
        setupListener('broadcastBtn', () => {
            if (confirm('Broadcast this item to all staff?')) {
                callApi(`/dashboard/api/lost-and-found/${itemId}/broadcast/`);
            }
        });
        
        setupListener('markFoundBtn', () => handleStatusUpdate('found', 'Mark as Found'));
        setupListener('markReturnedBtn', () => handleStatusUpdate('returned', 'Mark as Returned'));
        
        // Update Status Button
        document.getElementById('updateStatusBtn')?.addEventListener('click', function() {
            const newStatus = document.getElementById('statusSelect').value;
            handleStatusUpdate(newStatus, 'Update Status');
        });
        
        // Update Assignment Button
        document.getElementById('updateAssignmentBtn')?.addEventListener('click', function() {
            const departmentId = document.getElementById('departmentSelect').value;
            const userId = document.getElementById('userSelect').value;
            
            const formData = new FormData();
            formData.append('action', 'assign');
            if (departmentId) formData.append('department_id', departmentId);
            if (userId) formData.append('user_id', userId);
            
            fetch(`/dashboard/api/lost-and-found/${itemId}/update/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast('Assignment updated!', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast('Error: ' + (data.error || 'Failed'), 'error');
                }
            })
            .catch(err => {
                console.error(err);
                showToast('An error occurred.', 'error');
            });
        });
    });
</script>
{% endblock extra_js %}
