{% extends "dashboard/base_dashboard.html" %} 
{% load static %} 

{% block dashboard_content %}
<div class="min-h-screen bg-gray-50 py-8">
  <div class="max-w-4xl mx-auto px-4">
    {% csrf_token %}

    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">üì∑ Voucher Scanner</h1>
      <p class="text-gray-600">Scan QR codes to validate and redeem vouchers</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <div class="bg-white shadow-lg rounded-lg p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-gray-800">QR Code Scanner</h2>
          <div class="flex space-x-2">
            <button
              id="toggleCamera"
              class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600 transition"
            >
              üìπ Switch Camera
            </button>
            <button
              id="stopScanner"
              class="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition"
            >
              ‚èπÔ∏è Stop
            </button>
          </div>
        </div>

        <div id="cameraSelection" class="mb-4 hidden">
          <label class="block text-sm font-medium text-gray-700 mb-2"
            >Select Camera:</label
          >
          <select
            id="cameraSelect"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          >
            <option value="">Loading cameras...</option>
          </select>
        </div>

        <div class="relative">
          <div
            id="reader"
            class="rounded-lg border-2 border-gray-300 overflow-hidden"
            style="width: 100%; max-width: 500px; margin: 0 auto"
          ></div>

          <div
            id="scannerStatus"
            class="mt-4 p-3 rounded-lg bg-gray-100 text-center"
          >
            <div class="flex items-center justify-center space-x-2">
              <div
                id="statusSpinner"
                class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500"
              ></div>
              <span id="statusText" class="text-sm text-gray-600"
                >Initializing camera...</span
              >
            </div>
          </div>
        </div>

        <div class="mt-6 pt-6 border-t border-gray-200">
          <h3 class="text-lg font-medium text-gray-800 mb-3">Manual Entry</h3>
          <form id="manualForm" class="space-y-3">
            <div>
              <input
                type="text"
                id="manualCode"
                placeholder="Enter voucher code manually"
                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <button
              type="submit"
              class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition font-medium"
            >
              Validate Voucher
            </button>
          </form>
        </div>
      </div>

      <div class="bg-white shadow-lg rounded-lg p-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Scan Results</h2>

        <div id="currentResult" class="mb-6">
          <div class="p-4 bg-gray-50 rounded-lg text-center text-gray-500">
            <div class="text-4xl mb-2">üîç</div>
            <p>Waiting for scan...</p>
          </div>
        </div>

        <div id="scanHistory">
          <h3 class="text-lg font-medium text-gray-800 mb-3">Recent Scans</h3>
          <div id="historyList" class="space-y-2 max-h-64 overflow-y-auto">
            </div>
        </div>

        <div class="mt-6 pt-6 border-t border-gray-200">
          <h3 class="text-lg font-medium text-gray-800 mb-3">Session Stats</h3>
          <div class="grid grid-cols-3 gap-4 text-center">
            <div class="bg-green-50 p-3 rounded-lg">
              <div id="successCount" class="text-2xl font-bold text-green-600">
                0
              </div>
              <div class="text-sm text-green-600">Successful</div>
            </div>
            <div class="bg-red-50 p-3 rounded-lg">
              <div id="failedCount" class="text-2xl font-bold text-red-600">
                0
              </div>
              <div class="text-sm text-red-600">Failed</div>
            </div>
            <div class="bg-blue-50 p-3 rounded-lg">
              <div id="totalCount" class="text-2xl font-bold text-blue-600">
                0
              </div>
              <div class="text-sm text-blue-600">Total</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
  class VoucherScanner {
    constructor() {
      this.scanner = null;
      this.isScanning = false;
      this.cameras = [];
      this.currentCameraIndex = 0;
      this.scanHistory = [];
      this.stats = { success: 0, failed: 0, total: 0 };

      this.init();
    }

    async init() {
      try {
        // Get available cameras
        this.cameras = await Html5Qrcode.getCameras();
        this.populateCameraSelect();

        // Initialize scanner
        this.scanner = new Html5Qrcode("reader");

        // Setup event listeners
        this.setupEventListeners();

        // Start scanning
        await this.startScanning();
      } catch (error) {
        console.error("Failed to initialize scanner:", error);
        this.updateStatus("‚ùå Failed to access camera", "error");
      }
    }

    populateCameraSelect() {
      const select = document.getElementById("cameraSelect");
      select.innerHTML = "";

      this.cameras.forEach((camera, index) => {
        const option = document.createElement("option");
        option.value = index;
        option.textContent = camera.label || `Camera ${index + 1}`;
        select.appendChild(option);
      });

      if (this.cameras.length > 1) {
        document.getElementById("cameraSelection").classList.remove("hidden");
      }
    }

    setupEventListeners() {
      // Toggle camera button
      document.getElementById("toggleCamera").addEventListener("click", () => {
        this.switchCamera();
      });

      // Stop scanner button
      document.getElementById("stopScanner").addEventListener("click", () => {
        this.stopScanning();
      });

      // Camera selection
      document
        .getElementById("cameraSelect")
        .addEventListener("change", (e) => {
          this.currentCameraIndex = parseInt(e.target.value);
          this.restartScanning();
        });

      // Manual form submission
      document.getElementById("manualForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const code = document.getElementById("manualCode").value.trim();
        if (code) {
          this.validateVoucher(code, "manual");
          document.getElementById("manualCode").value = "";
        }
      });
    }

    async startScanning() {
      if (this.isScanning || this.cameras.length === 0) return;

      try {
        const cameraId = this.cameras[this.currentCameraIndex]?.id;
        if (!cameraId) {
          throw new Error("No camera available");
        }

        await this.scanner.start(
          cameraId,
          {
            fps: 10,
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0,
          },
          (decodedText, decodedResult) => {
            this.onScanSuccess(decodedText, decodedResult);
          },
          (errorMessage) => {
            // Ignore frequent scan errors
          }
        );

        this.isScanning = true;
        this.updateStatus("üì∑ Scanning...", "success");
      } catch (error) {
        console.error("Failed to start scanning:", error);
        this.updateStatus(`‚ùå Camera error: ${error.message}`, "error");
      }
    }

    async stopScanning() {
      if (!this.isScanning) return;

      try {
        await this.scanner.stop();
        this.isScanning = false;
        this.updateStatus("‚èπÔ∏è Scanner stopped", "warning");
      } catch (error) {
        console.error("Failed to stop scanning:", error);
      }
    }

    async restartScanning() {
      await this.stopScanning();
      setTimeout(() => this.startScanning(), 500);
    }

    async switchCamera() {
      if (this.cameras.length <= 1) return;

      this.currentCameraIndex =
        (this.currentCameraIndex + 1) % this.cameras.length;
      document.getElementById("cameraSelect").value = this.currentCameraIndex;
      await this.restartScanning();
    }

    onScanSuccess(decodedText, decodedResult) {
      // Temporarily stop scanning to prevent duplicate scans
      this.stopScanning();

      // Validate the voucher
      this.validateVoucher(decodedText, "qr_scan");

      // Restart scanning after a delay
      setTimeout(() => {
        if (!this.isScanning) {
          this.startScanning();
        }
      }, 3000);
    }

    async validateVoucher(code, source = "qr_scan") {
      try {
        this.updateStatus("üîÑ Validating voucher...", "processing");

        // Prepare request data
        const requestData = {
          voucher_code: code,
          scan_location: "Restaurant", // Could be made dynamic
        };

        // Get CSRF token
        const csrfToken = document.querySelector(
          "[name=csrfmiddlewaretoken]"
        )?.value;

        const response = await fetch("/api/vouchers/validate/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfToken,
            Authorization: `Bearer ${this.getAuthToken()}`,
          },
          body: JSON.stringify(requestData),
        });

        const data = await response.json();

        // Update UI based on result
        this.displayResult(data, code, source);
        this.addToHistory(data, code, source);
        this.updateStats(data.valid);
      } catch (error) {
        console.error("Validation error:", error);
        const errorData = {
          valid: false,
          message: "Network error - please try again",
          error_code: "NETWORK_ERROR",
        };
        this.displayResult(errorData, code, source);
        this.addToHistory(errorData, code, source);
        this.updateStats(false);
      }
    }

    displayResult(data, code, source) {
      const resultDiv = document.getElementById("currentResult");
      const timestamp = new Date().toLocaleTimeString();

      let statusClass, icon, statusText;

      if (data.valid) {
        statusClass = "bg-green-50 border-green-200 text-green-800";
        icon = "‚úÖ";
        statusText = "Valid & Redeemed";
      } else {
        statusClass = "bg-red-50 border-red-200 text-red-800";
        icon = "‚ùå";
        statusText = "Invalid/Failed";
      }

      const voucherDetails = data.voucher_details;

      resultDiv.innerHTML = `
      <div class="p-4 border-2 rounded-lg ${statusClass}">
        <div class="text-center mb-3">
          <div class="text-4xl mb-2">${icon}</div>
          <div class="text-lg font-semibold">${statusText}</div>
          <div class="text-sm opacity-75">${timestamp}</div>
        </div>
        
        <div class="space-y-2 text-sm">
          <div><strong>Code:</strong> ${code}</div>
          <div><strong>Source:</strong> ${
            source === "qr_scan" ? "QR Scan" : "Manual Entry"
          }</div>
          <div><strong>Message:</strong> ${data.message}</div>
          
          ${
            voucherDetails
              ? `
            <div class="mt-3 pt-3 border-t border-gray-300">
              <div><strong>Guest:</strong> ${voucherDetails.guest_name}</div>
              <div><strong>Room:</strong> ${
                voucherDetails.room_number || "N/A"
              }</div>
              <div><strong>Type:</strong> ${voucherDetails.voucher_type}</div>
              <div><strong>Valid Until:</strong> ${
                voucherDetails.valid_to
              }</div>
            </div>
          `
              : ""
          }
        </div>
      </div>
    `;

      // Auto-scroll to result
      resultDiv.scrollIntoView({ behavior: "smooth", block: "nearest" });
    }

    addToHistory(data, code, source) {
      const timestamp = new Date();
      const historyItem = {
        timestamp,
        code,
        source,
        valid: data.valid,
        message: data.message,
        guestName: data.voucher_details?.guest_name,
      };

      this.scanHistory.unshift(historyItem);

      // Keep only last 10 items
      if (this.scanHistory.length > 10) {
        this.scanHistory = this.scanHistory.slice(0, 10);
      }

      this.updateHistoryDisplay();
    }

    updateHistoryDisplay() {
      const historyList = document.getElementById("historyList");

      historyList.innerHTML = this.scanHistory
        .map((item) => {
          const timeStr = item.timestamp.toLocaleTimeString();
          const statusIcon = item.valid ? "‚úÖ" : "‚ùå";
          const statusClass = item.valid ? "text-green-600" : "text-red-600";

          return `
        <div class="flex items-center justify-between p-2 bg-gray-50 rounded text-sm">
          <div class="flex items-center space-x-2">
            <span class="${statusClass}">${statusIcon}</span>
            <span class="font-mono text-xs">${item.code.substring(
              0,
              8
            )}...</span>
            ${
              item.guestName
                ? `<span class="text-gray-600">${item.guestName}</span>`
                : ""
            }
          </div>
          <span class="text-gray-500 text-xs">${timeStr}</span>
        </div>
      `;
        })
        .join("");
    }

    updateStats(success) {
      this.stats.total++;
      if (success) {
        this.stats.success++;
      } else {
        this.stats.failed++;
      }

      document.getElementById("successCount").textContent = this.stats.success;
      document.getElementById("failedCount").textContent = this.stats.failed;
      document.getElementById("totalCount").textContent = this.stats.total;
    }

    updateStatus(message, type = "info") {
      const statusText = document.getElementById("statusText");
      const statusSpinner = document.getElementById("statusSpinner");

      statusText.textContent = message;

      // Update spinner visibility and color based on type
      if (type === "processing") {
        statusSpinner.classList.remove("hidden");
      } else {
        statusSpinner.classList.add("hidden");
      }

      // Update text color based on type
      statusText.className = `text-sm ${
        type === "success"
          ? "text-green-600"
          : type === "error"
          ? "text-red-600"
          : type === "warning"
          ? "text-yellow-600"
          : "text-gray-600"
      }`;
    }

    getAuthToken() {
      // Get JWT token from localStorage or cookie
      return localStorage.getItem("access_token") || "";
    }
  }

  // Initialize scanner when page loads
  document.addEventListener("DOMContentLoaded", () => {
    new VoucherScanner();
  });
</script>

<style>
  @media (max-width: 768px) {
    .grid-cols-1.lg\:grid-cols-2 {
      grid-template-columns: 1fr;
    }

    #reader {
      width: 100% !important;
      height: 300px !important;
    }
  }

  #reader video {
    border-radius: 8px;
  }

  .animate-spin {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }
</style>
{% endblock %}