{% extends "dashboard/base_dashboard.html" %}
{% load static %}
{% load dashboard2_extras %}

{% block extra_css %}
<style>
    /* Custom CSS for animations and smooth scrolling */
    html {
        scroll-behavior: smooth;
    }
    
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-slide-in-up {
        opacity: 0; /* Start hidden */
        animation: slideInUp 0.6s ease-out forwards;
    }
    /* Floating Mobile Create Ticket Button */
    .fab-create-ticket {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 900;
        width: 56px;
        height: 56px;
        border-radius: 100%;
        background: #0284c7;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 10px 25px -5px rgba(14, 165, 233, 0.3);
        transition: all 0.2s ease;
    }
    .fab-create-ticket:hover {
        background: #0369a1;
        transform: scale(1.05);
    }
    /* Hide FAB on desktop */
    @media (min-width: 768px) {
        .fab-create-ticket {
            display: none;
        }
    }

    .autocomplete-list {
        position: absolute;
        z-index: 50;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 0.5rem;
        margin-top: 0.25rem;
        max-height: 12rem;
        overflow-y: auto;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
    }

    .autocomplete-item {
        padding: 0.5rem 0.75rem;
        cursor: pointer;
    }

    .autocomplete-item:hover {
        background: #eff6ff;
    }
</style>
{% endblock extra_css %}

{% block content %}
<div class="w-full max-w-7xl mx-auto bg-gray-50 font-['Inter']">

    <div class="w-full h-16 bg-white border-b border-gray-200 flex items-center px-4 sm:px-6">
        <div class="w-full flex justify-between items-center">
            <div class="flex items-center gap-4">
                <h1 class="text-gray-900 text-2xl font-bold">My Tickets</h1>
                <div class="hidden sm:flex items-center gap-2">
                    <span class="px-3 py-1 bg-blue-100 text-sky-600 text-xs font-medium rounded-full">
                        {{ page_obj.paginator.count|default:0 }} Active
                    </span>
                    {# Note: You must pass 'overdue_count' from your view for this to be dynamic #}
                    <span class="px-3 py-1 bg-yellow-100 text-yellow-400 text-xs font-medium rounded-full">
                        {{ overdue_count|default:0 }} Overdue
                    </span>
                </div>
            </div>
            
            <div class="flex items-center gap-2 sm:gap-4">
                <!-- <a href="#" class="hidden sm:flex items-center justify-center gap-2 h-9 px-4 bg-sky-600 hover:bg-sky-700 text-white text-sm font-medium rounded-lg transition-colors">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
                    New Ticket
                </a> -->
            </div>
        </div>
    </div>

    <div class="w-full bg-white border-b border-gray-200 px-4 sm:px-6 py-3">
        <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
            <form autocomplete="off" id="filterForm" method="get" class="flex flex-wrap items-center gap-3 w-full sm:w-auto">
                <input autocomplete="off" type="hidden" name="search" value="{{ search_query|default:'' }}">
                
                <select name="priority" onchange="this.form.submit()" class="w-full sm:w-auto flex-grow h-9 rounded-lg border border-gray-300 bg-gray-50 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 cursor-pointer">
                    <option value="">All Priorities</option>
                    <option value="High" {% if priority_filter == 'High' %}selected{% endif %}>High</option>
                    <option value="Medium" {% if priority_filter == 'Medium' %}selected{% endif %}>Medium</option>
                    <option value="Low" {% if priority_filter == 'Low' %}selected{% endif %}>Low</option>
                </select>
                
                <select name="status" onchange="this.form.submit()" class="w-full sm:w-auto flex-grow h-9 rounded-lg border border-gray-300 bg-gray-50 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 cursor-pointer">
                    <option value="">All Statuses</option>
                    <option value="Pending" {% if status_filter == 'Pending' %}selected{% endif %}>Pending</option>
                    <option value="Accepted" {% if status_filter == 'Accepted' %}selected{% endif %}>Accepted</option>
                    <option value="In Progress" {% if status_filter == 'In Progress' %}selected{% endif %}>In Progress</option>
                    <option value="Completed" {% if status_filter == 'Completed' %}selected{% endif %}>Completed</option>
                    <option value="Closed" {% if status_filter == 'Closed' %}selected{% endif %}>Closed</option>
                </select>
            </form>

            <div class="flex w-full sm:w-auto items-center gap-3">
                <form autocomplete="off" id="searchForm" method="get" class="relative flex-grow">
                    <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <input autocomplete="off" type="text" name="search" placeholder="Search tasks..." value="{{ search_query|default:'' }}" class="w-full h-9 pl-10 pr-4 bg-gray-50 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-sky-500" />
                    {% if priority_filter %}<input autocomplete="off" type="hidden" name="priority" value="{{ priority_filter }}">{% endif %}
                    {% if status_filter %}<input autocomplete="off" type="hidden" name="status" value="{{ status_filter }}">{% endif %}
                </form>
                </div>
        </div>
    </div>

    <div class="p-4 sm:p-6">
        {# Note: You must pass 'status_counts' dictionary from your view with keys like 'pending', 'accepted', etc. #}
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-xl border border-gray-200 p-4 flex justify-between items-center animate-slide-in-up" style="animation-delay: 0ms;">
                <div>
                    <div class="text-2xl font-bold text-gray-900">{{ status_counts.pending|default:0 }}</div>
                    <div class="text-sm text-gray-600">Pending</div>
                </div>
                <div class="w-10 h-10 bg-yellow-100 rounded-lg flex justify-center items-center">
                    <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
            </div>
            <div class="bg-white rounded-xl border border-gray-200 p-4 flex justify-between items-center animate-slide-in-up" style="animation-delay: 100ms;">
                <div>
                    <div class="text-2xl font-bold text-gray-900">{{ status_counts.accepted|default:0 }}</div>
                    <div class="text-sm text-gray-600">Accepted</div>
                </div>
                <div class="w-10 h-10 bg-sky-100 rounded-lg flex justify-center items-center">
                    <svg class="w-5 h-5 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </div>
            </div>
            <div class="bg-white rounded-xl border border-gray-200 p-4 flex justify-between items-center animate-slide-in-up" style="animation-delay: 200ms;">
                <div>
                    <div class="text-2xl font-bold text-gray-900">{{ status_counts.in_progress|default:0 }}</div>
                    <div class="text-sm text-gray-600">In Progress</div>
                </div>
                <div class="w-10 h-10 bg-sky-100 rounded-lg flex justify-center items-center">
                     <svg class="w-5 h-5 text-sky-600 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 20h5v-5M20 4h-5v5"></path></svg>
                </div>
            </div>
            <div class="bg-white rounded-xl border border-gray-200 p-4 flex justify-between items-center animate-slide-in-up" style="animation-delay: 300ms;">
                <div>
                    <div class="text-2xl font-bold text-gray-900">{{ status_counts.completed|default:0 }}</div>
                    <div class="text-sm text-gray-600">Completed</div>
                </div>
                <div class="w-10 h-10 bg-green-100 rounded-lg flex justify-center items-center">
                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
            </div>
        </div>

        <div class="hidden md:block bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="grid" style="grid-template-columns: 3fr 1.5fr 1.5fr 1fr 1.5fr 1.5fr;">
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 text-left text-sm font-semibold text-gray-700">Task</div>
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 text-left text-sm font-semibold text-gray-700">Priority</div>
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 text-left text-sm font-semibold text-gray-700">Room/Location</div>
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 text-left text-sm font-semibold text-gray-700">Actions</div>
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 text-left text-sm font-semibold text-gray-700">Due Date</div>
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 text-left text-sm font-semibold text-gray-700">Workflow</div>
            </div>
            <div>
                {% for ticket in tickets %}
                <div class="grid items-center hover:bg-gray-50" style="grid-template-columns: 3fr 1.5fr 1.5fr 1fr 1.5fr 1.5fr;">
                    <div class="px-6 py-4 border-b border-gray-100">
                        <p class="text-base font-medium text-gray-900"><span class="text-gray-800 font-bold px-6">
            #{{ ticket.id }}
        </span>{{ ticket.request_type.name }}</p>
                        <p class="text-sm text-gray-500 truncate">{{ ticket.notes|truncatewords:10 }}</p>
                    </div>
                    <div class="px-6 py-4 border-b border-gray-100">
                        <span class="px-3 py-1 inline-flex text-xs font-medium rounded-full 
                            {% if ticket.priority_label == 'High' %}bg-red-100 text-red-600
                            {% elif ticket.priority_label == 'Medium' %}bg-yellow-100 text-yellow-600
                            {% else %}bg-green-100 text-green-600{% endif %}">
                            {{ ticket.priority_label }}
                        </span>
                    </div>
                    <div class="px-6 py-4 border-b border-gray-100">
                        <p class="text-sm font-medium text-black">{{ ticket.location }}</p>
                        <p class="text-sm text-gray-500">{{ ticket.location.floor|default:'N/A' }}</p>
                    </div>
                    <div class="px-6 py-4 border-b border-gray-100">
                        <a href="{% url 'dashboard:ticket_detail' ticket.id %}" class="text-gray-600 hover:text-gray-900">
                            <img src="{% static 'images/tickets/eye.svg' %}" alt="View" class="w-5 h-5">
                        </a>
                    </div>
                    <div class="px-6 py-4 border-b border-gray-100">
                        <p class="text-sm font-medium {% if ticket.sla_breached %}text-red-500{% else %}text-black{% endif %}">
                            {{ ticket.get_time_left }}
                        </p>
                        <p class="text-sm text-gray-500">
                           {% if ticket.sla_breached %}Overdue{% else %}On Time{% endif %}
                        </p>
                    </div>
                    <div class="px-6 py-4 border-b border-gray-100">
                        <div class="flex items-center gap-2">
                            {% if ticket.can_accept %}
                                <button class="accept-start-ticket-btn text-xs font-medium text-white bg-sky-600 hover:bg-sky-700 rounded px-3 py-1.5" data-ticket-id="{{ ticket.id }}">Accept & Start</button>
                            {% elif ticket.can_complete %}
                                <button class="complete-ticket-btn text-xs font-medium text-white bg-green-500 hover:bg-green-600 rounded px-3 py-1.5" data-ticket-id="{{ ticket.id }}">Complete</button>
                            {% endif %}
                            <a href="{% url 'dashboard:ticket_detail' ticket.id %}" class="p-2 rounded-lg text-gray-500 hover:bg-gray-100" title="View Details">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </a>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-span-full text-center py-12 text-gray-500">No tasks found.</div>
                {% endfor %}
            </div>
        </div>

        <div class="block md:hidden space-y-4">
            {% for ticket in tickets %}
            <div class="bg-white rounded-xl border border-gray-200 p-4 shadow-sm">
                <div class="flex justify-between items-start gap-4">
                    <div>
                        <p class="text-base font-medium text-gray-900"><span class="text-gray-800 font-bold px-6">
            #{{ ticket.id }}
        </span>{{ ticket.request_type.name }}</p>
                        <p class="text-sm text-gray-600">{{ ticket.location }} â€¢ {{ ticket.location.floor|default:'N/A' }}</p>
                    </div>
                    <span class="px-3 py-1 inline-flex text-xs font-medium rounded-full 
                        {% if ticket.priority_label == 'High' %}bg-red-100 text-red-600
                        {% elif ticket.priority_label == 'Medium' %}bg-yellow-100 text-yellow-600
                        {% else %}bg-green-100 text-green-600{% endif %}">
                        {{ ticket.priority_label }}
                    </span>
                </div>

                <div class="flex items-center gap-4 my-3 text-xs">
                    <a href="{% url 'dashboard:ticket_detail' ticket.id %}" class="text-gray-600 hover:text-gray-900">
                        <img src="{% static 'images/tickets/eye.svg' %}" alt="View" class="w-5 h-5">
                    </a>
                    <span class="text-neutral-500">Due: {{ ticket.get_time_left }}</span>
                </div>

                <div class="my-4">
                    <div class="flex justify-between items-center text-xs text-gray-600 mb-1">
                        <span>SLA Progress</span>
                        <span class="font-medium {% if ticket.sla_breached %}text-red-500{% else %}text-gray-600{% endif %}">
                            {{ ticket.sla_progress_percent|default:0 }}%
                        </span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                        <div class="h-1.5 rounded-full 
                            {% if ticket.sla_breached %}bg-red-500
                            {% else %}bg-green-500{% endif %}" style="width: {{ ticket.sla_progress_percent|default:0 }}%"></div>
                    </div>
                    <div class="mt-1">
                        {% if ticket.sla_breached %}
                            <span class="px-2 py-1 text-xs font-medium text-white bg-red-500 rounded-full inline-flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Breached
                            </span>
                        {% else %}
                            <span class="px-2 py-1 text-xs font-medium text-white bg-green-500 rounded-full inline-flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                On Track
                            </span>
                        {% endif %}
                    </div>
                </div>                <div class="flex items-center gap-2">
                    {% if ticket.can_accept %}
                        <button class="accept-start-ticket-btn flex-grow text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 rounded-lg h-10 flex items-center justify-center" data-ticket-id="{{ ticket.id }}">Accept & Start</button>
                    {% elif ticket.can_complete %}
                        <button class="complete-ticket-btn flex-grow text-sm font-medium text-white bg-green-500 hover:bg-green-600 rounded-lg h-10 flex items-center justify-center" data-ticket-id="{{ ticket.id }}">Complete</button>
                    {% endif %}
                    <a href="{% url 'dashboard:ticket_detail' ticket.id %}" class="h-10 w-10 flex-shrink-0 flex items-center justify-center rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50" title="View Details">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </a>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-12">
                <p class="text-gray-500">No tickets found.</p>
            </div>
            {% endfor %}
        </div>
        <!-- Floating Mobile Create Ticket Shortcut Button -->
    <button id="fabCreateTicketBtn" class="fab-create-ticket" title="Create New Ticket">
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
    </button>
</div>

<!-- Create Ticket Modal (Same style as main tickets page) -->
<div id="createTicketModal" class="hidden fixed inset-0 z-[1000] items-center justify-center p-4 backdrop-blur-md bg-black/30 transition-opacity duration-300 opacity-0" onclick="closeCreateTicketModal()">
    <div id="modalContent" class="w-full max-w-2xl rounded-lg bg-white shadow-xl transform transition-all duration-300 scale-95 opacity-0 flex flex-col max-h-[95vh]" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center p-6 border-b border-gray-200 flex-shrink-0">
            <h2 class="text-xl font-semibold text-gray-900">Create New Ticket</h2>
            <button id="closeCreateTicketModal" class="rounded-full p-1 text-gray-500 hover:bg-gray-100 transition-colors" aria-label="Close">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <form autocomplete="off" class="p-6 space-y-6 overflow-y-auto flex-grow" onsubmit="return false;">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="roomNumber" class="block text-sm font-medium text-gray-700 mb-1">
                    Room Number
                </label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <img src="{% static 'images/tickets/room.svg' %}" alt="Room Icon" class="h-5 w-5 text-gray-400" />
                    </div>
                    <input type="hidden" id="guestName" value="">
                    <input type="hidden" id="guestId" value="">
                    <input type="hidden" id="guestPhone" value="">
                    <input type="hidden" id="guestCountryCode" value="">
                    <input type="hidden" id="locationId" name="location_id" value="">

                    <input autocomplete="off"
                           type="text"
                           id="roomNumber"
                           placeholder="Enter room number"
                           class="w-full h-11 pl-10 pr-4 bg-white rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-sky-500">

                    <div id="roomSuggestions"
                         class="absolute z-20 mt-1 w-full bg-white shadow-lg rounded-md hidden max-h-60 overflow-auto border border-gray-200">
                    </div>
                </div>

                <div id="selectedRoomDetails"
                     class="hidden mt-3 p-3 bg-blue-50 rounded-lg border border-blue-100 transition-all duration-300">
                    <div class="flex gap-6 text-sm items-center">
                        <div>
                            <span class="block text-gray-500 text-xs uppercase">Building</span>
                            <span class="font-semibold text-gray-900" id="detailBuilding">-</span>
                        </div>
                        <div>
                            <span class="block text-gray-500 text-xs uppercase">Floor</span>
                            <span class="font-semibold text-gray-900" id="detailFloor">-</span>
                        </div>
                    </div>
                </div>
            </div>
            </div>
            <div>
                <label for="department" class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                <div class="relative"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><img src="{% static 'images/tickets/department.svg' %}" alt="Department Icon" class="h-5 w-5 text-gray-400" /></div><select id="department" class="w-full h-11 pl-10 pr-4 bg-white rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-sky-500 appearance-none"><option value="">Select department</option>{% for dept in departments %}<option value="{{ dept.name }}">{{ dept.name }}</option>{% endfor %}</select><div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div></div>
            </div>
            <div class="relative">
                <label for="requestType" class="block text-sm font-medium text-gray-700 mb-1">Request Type</label>
                <div class="relative">
                    <input autocomplete="off" type="text" id="requestType" placeholder="Search and select request type..." class="w-full h-11 pl-10 pr-4 bg-white rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-sky-500">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <img src="{% static 'images/tickets/category.svg' %}" alt="Category Icon" class="h-5 w-5 text-gray-400" />
                    </div>
                    <div id="requestTypeSuggestions" class="absolute z-10 mt-1 w-full bg-white shadow-lg rounded-md hidden max-h-60 overflow-auto">
                        </div>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Priority Level</label>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><button type="button" class="priority-btn w-full flex items-center gap-3 p-3 rounded-lg border border-gray-300 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500" data-priority="Critical"><span class="w-4 h-4 rounded-full bg-red-500"></span><span class="text-sm font-medium text-gray-700">Critical</span></button><button type="button" class="priority-btn w-full flex items-center gap-3 p-3 rounded-lg border border-gray-300 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500" data-priority="High"><span class="w-4 h-4 rounded-full bg-yellow-400"></span><span class="text-sm font-medium text-gray-700">High</span></button><button type="button" class="priority-btn w-full flex items-center gap-3 p-3 rounded-lg border border-gray-300 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500" data-priority="Medium"><span class="w-4 h-4 rounded-full bg-sky-500"></span><span class="text-sm font-medium text-gray-700">Medium</span></button><button type="button" class="priority-btn w-full flex items-center gap-3 p-3 rounded-lg border border-gray-300 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500" data-priority="Low"><span class="w-4 h-4 rounded-full bg-green-500"></span><span class="text-sm font-medium text-gray-700">Low</span></button></div>
            </div>
            <div>
                <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Description</label><textarea id="description" rows="4" placeholder="Describe the issue or request..." class="w-full p-3 bg-white rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-sky-500 resize-none"></textarea>
            </div>
            <div>
                <label for="attachments" class="block text-sm font-medium text-gray-700 mb-1">
    Attachments (Optional)
</label>

<div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md hover:border-sky-400 transition">
    <div class="space-y-2 text-center">
        <img src="{% static 'images/tickets/file.svg' %}"
             class="mx-auto h-12 w-12 text-gray-400"
             alt="File upload icon">

        <div class="flex text-sm text-gray-600 justify-center">
            <label for="attachments"
                   class="relative cursor-pointer bg-white rounded-md font-medium text-sky-600 hover:text-sky-500
                          focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-sky-500">
                <span>Upload photos or videos</span>
                <input
                    autocomplete="off"
                    id="attachments"
                    name="attachments"
                    type="file"
                    multiple
                    accept=".jpg,.jpeg,.png,.mp4"
                    class="sr-only">
            </label>
        </div>

        <p class="text-xs text-gray-500">
            JPG, JPEG, PNG, MP4 Â· Max 50MB each
        </p>
        <ul id="attachmentPreview" class="text-xs text-gray-700 mt-2 space-y-1"></ul>
    </div>
</div>
            </div>
        </form>
        <div class="flex justify-end items-center gap-4 p-6 border-t border-gray-200 bg-gray-50 rounded-b-lg flex-shrink-0">
            <button id="cancelCreateTicket" class="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-800 hover:bg-gray-50">Cancel</button>
            <button id="submitCreateTicket" class="rounded-md bg-sky-600 px-4 py-2 text-sm font-medium text-white hover:bg-sky-700">Create Ticket</button>
        </div>
    </div>
</div>

<!-- Resolution Notes Modal -->
<div id="resolutionNotesModal" class="fixed inset-0 z-[1000] hidden items-center justify-center p-4 backdrop-blur-sm bg-black bg-opacity-30 transition-opacity duration-300 opacity-0" onclick="closeResolutionNotesModal()">
    <div class="w-full max-w-md rounded-lg bg-white shadow-xl transform transition-all duration-300 scale-95 opacity-0" onclick="event.stopPropagation()">
        <div class="p-6">
            <div class="flex items-start justify-between">
                <h3 class="text-lg font-semibold text-gray-900">Resolution Notes</h3>
                <button type="button" onclick="closeResolutionNotesModal()" class="rounded-full p-1 text-gray-500 hover:bg-gray-100 transition-colors" aria-label="Close">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="mt-4">
                <label for="resolutionNotesInput" class="block text-sm font-medium text-gray-700 mb-2">Please enter resolution notes:</label>
                <textarea id="resolutionNotesInput" rows="4" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Describe how this ticket was resolved..."></textarea>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="cancelResolutionNotes" class="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-800 hover:bg-gray-50">Cancel</button>
                <button type="button" id="submitResolutionNotes" class="rounded-md bg-sky-600 px-4 py-2 text-sm font-medium text-white hover:bg-sky-700">Submit</button>
            </div>
        </div>
    </div>
</div>
<div id="toastNotification" class="fixed top-4 right-4 z-[1000] hidden items-center rounded-lg px-4 py-2 text-white shadow-lg transition-all duration-300 transform translate-x-full opacity-0">
    <span id="toastMessage"></span>
</div>
{% endblock content %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function handleTicketAction(button, url, options = {}) {
        const ticketId = button.getAttribute('data-ticket-id');
        let confirmationMessage = options.confirmationMessage || 'Are you sure?';
        
        let body = {};
        if (options.requiresNotes) {
            // Show resolution notes modal instead of using prompt
            showResolutionNotesModal(url.replace('TICKET_ID', ticketId), options);
            return;
        }

        // Use custom confirmation modal instead of browser confirm
        if (!options.requiresNotes) {
            showConfirmationModal('Confirm Action', confirmationMessage, function() {
                performTicketAction(ticketId, url, body, options);
            });
            return;
        }

        // For actions that require notes, proceed directly
        performTicketAction(ticketId, url, body, options);
    }

    function performTicketAction(ticketId, url, body, options) {
        fetch(url.replace('TICKET_ID', ticketId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: Object.keys(body).length > 0 ? JSON.stringify(body) : null
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Use toast notification instead of alert
                showToast(options.successMessage || 'Action successful!', 'success');
                location.reload();
            } else {
                // Use toast notification for errors
                showToast('Error: ' + (data.error || 'An unknown error occurred.'), 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Use toast notification for errors
            showToast('An error occurred. Please try again.', 'error');
        });
    }

    // Function to show resolution notes modal
    function showResolutionNotesModal(url, options) {
        const modal = document.getElementById('resolutionNotesModal');
        const textarea = document.getElementById('resolutionNotesInput');
        const submitButton = document.getElementById('submitResolutionNotes');
        
        if (!modal || !textarea || !submitButton) return;
        
        // Clear previous content
        textarea.value = '';
        
        // Set up submit action
        submitButton.onclick = function() {
            const notes = textarea.value.trim();
            if (!notes) {
                showToast('Please enter resolution notes.', 'error');
                return;
            }
            
            const body = {};
            body[options.notesField] = notes;
            
            closeResolutionNotesModal();
            performTicketAction(null, url, body, options);
        };
        
        // Show modal with animation
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        requestAnimationFrame(() => {
            modal.classList.remove('opacity-0');
            const dialog = modal.querySelector('div[onclick="event.stopPropagation()"]');
            if (dialog) {
                dialog.classList.remove('scale-95', 'opacity-0');
                dialog.classList.add('scale-100', 'opacity-100');
            }
        });
        
        // Focus the textarea
        setTimeout(() => textarea.focus(), 300);
    }
    
    // Function to close resolution notes modal
    function closeResolutionNotesModal() {
        const modal = document.getElementById('resolutionNotesModal');
        if (!modal) return;
        
        const dialog = modal.querySelector('div[onclick="event.stopPropagation()"]');
        modal.classList.add('opacity-0');
        if (dialog) {
            dialog.classList.remove('scale-100', 'opacity-100');
            dialog.classList.add('scale-95', 'opacity-0');
        }
        
        setTimeout(() => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }, 300);
    }
    document.getElementById('cancelResolutionNotes')
    .addEventListener('click', closeResolutionNotesModal);

    document.body.addEventListener('click', function(event) {
        const button = event.target.closest('button');
        if (!button) return;

        if (button.classList.contains('accept-start-ticket-btn')) {
            handleTicketAction(button, '/dashboard/api/tickets/TICKET_ID/accept-and-start/', {
                confirmationMessage: 'Are you sure you want to accept and start working on this ticket?',
                successMessage: 'Ticket accepted and work started successfully!'
            });
        }
        else if (button.classList.contains('complete-ticket-btn')) {
            handleTicketAction(button, '/dashboard/api/tickets/TICKET_ID/complete/', {
                requiresNotes: true,
                notesPrompt: 'Please enter resolution notes:',
                notesField: 'resolution_notes',
                successMessage: 'Ticket marked as completed successfully!'
            });
        }
    });

    // ==============================================
    // NEW: CREATE TICKET MODAL FUNCTIONALITY
    // ==============================================
    const openModalBtns = [document.getElementById('headerCreateTicketBtn'), document.getElementById('fabCreateTicketBtn')];
    const closeModalBtn = document.getElementById('closeCreateTicketModal');
    const cancelBtn = document.getElementById('cancelCreateTicket');
    const modal = document.getElementById('createTicketModal');
    const modalContent = document.getElementById('modalContent');
    let selectedPriority = '';
    let selectedRequestType = null;

    const openModal = () => { 
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        requestAnimationFrame(() => {
            modal.classList.remove('opacity-0');
            modalContent.classList.remove('scale-95', 'opacity-0');
            modalContent.classList.add('scale-100', 'opacity-100');
        });
    };

    window.closeCreateTicketModal = function() {
        modal.classList.add('opacity-0');
        modalContent.classList.remove('scale-100', 'opacity-100');
        modalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }, 300);
    }

    openModalBtns.forEach(btn => btn && btn.addEventListener('click', openModal));
    if (closeModalBtn) closeModalBtn.addEventListener('click', closeCreateTicketModal);
    if (cancelBtn) cancelBtn.addEventListener('click', closeCreateTicketModal);
    if (modal) modal.addEventListener('click', (e) => { if (e.target === modal) closeCreateTicketModal(); });

    // Priority selection
    document.querySelectorAll('.priority-btn').forEach(button => { button.addEventListener('click', (e) => {
        e.preventDefault();
        document.querySelectorAll('.priority-btn').forEach(btn => btn.classList.remove('ring-2', 'ring-offset-2', 'ring-sky-500'));
        button.classList.add('ring-2', 'ring-offset-2', 'ring-sky-500');
        selectedPriority = button.dataset.priority; 
    }); });

    // Request type suggestions
    const requestTypeField = document.getElementById('requestType');
    const requestTypeSuggestions = document.getElementById('requestTypeSuggestions');
    const departmentSelect = document.getElementById('department');
    
    function fetchRequestTypeSuggestions() {
        const searchTerm = requestTypeField.value.trim();
        const departmentName = departmentSelect.value;
        if (searchTerm.length < 2) {
            requestTypeSuggestions.classList.add('hidden');
            return;
        }
        const url = `/dashboard/api/tickets/suggestions/?search_term=${encodeURIComponent(searchTerm)}&department_name=${encodeURIComponent(departmentName)}`;
        fetch(url)
        .then(response => response.json())
        .then(data => {
            requestTypeSuggestions.innerHTML = '';
            if (data.success && data.suggestions.length > 0) {
                data.suggestions.forEach(suggestion => {
                    const suggestionElement = document.createElement('div');
                    suggestionElement.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm';
                    suggestionElement.textContent = suggestion.suggestion_text;
                    suggestionElement.addEventListener('click', () => {
                        requestTypeField.value = suggestion.name;
                        selectedRequestType = suggestion;
                        requestTypeSuggestions.classList.add('hidden');
                    });
                    requestTypeSuggestions.appendChild(suggestionElement);
                });
                requestTypeSuggestions.classList.remove('hidden');
            } else {
                requestTypeSuggestions.classList.add('hidden');
            }
        })
    }
    if (requestTypeField) {
        requestTypeField.addEventListener('input', fetchRequestTypeSuggestions);
        requestTypeField.addEventListener('focus', fetchRequestTypeSuggestions);
    }
    if (departmentSelect) departmentSelect.addEventListener('change', fetchRequestTypeSuggestions);
    document.addEventListener('click', (e) => {
        if (!requestTypeField.contains(e.target) && !requestTypeSuggestions.contains(e.target)) requestTypeSuggestions.classList.add('hidden');
    });

    // Room + Guest Autocomplete
    const roomNumberInput = document.getElementById('roomNumber');
    const roomSuggestions = document.getElementById('roomSuggestions');
    const locationIdInput = document.getElementById('locationId');
    const selectedRoomDetailsDiv = document.getElementById('selectedRoomDetails');
    const detailBuildingSpan = document.getElementById('detailBuilding');
    const detailFloorSpan = document.getElementById('detailFloor');
    const guestNameInput = document.getElementById('guestName');
    const guestIdInput = document.getElementById('guestId');
    const guestPhoneInput = document.getElementById('guestPhone');
    const guestCountryCodeInput = document.getElementById('guestCountryCode');

    function clearRoomDetails() {
        locationIdInput.value = '';
        detailBuildingSpan.textContent = '-';
        detailFloorSpan.textContent = '-';
        selectedRoomDetailsDiv.classList.add('hidden');
    }
    function hideRoomSuggestions() {
        roomSuggestions.innerHTML = '';
        roomSuggestions.classList.add('hidden');
    }
    function renderRoomSuggestions(items) {
        roomSuggestions.innerHTML = '';
        if (!items || items.length === 0) { hideRoomSuggestions(); return; }
        items.forEach(item => {
            const option = document.createElement('div');
            option.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm flex flex-col';
            const roomLabel = item.room_no ? `Room ${item.room_no}` : (item.name || 'Room');
            const meta = `${item.building || '-'} â€¢ Floor ${item.floor || '-'}`;
            option.innerHTML = `<span class="font-medium text-gray-900">${roomLabel}</span><span class="text-xs text-gray-500">${meta}</span>`;
            option.addEventListener('click', () => {
                roomNumberInput.value = item.room_no || '';
                locationIdInput.value = item.location_id || '';
                detailBuildingSpan.textContent = item.building || '-';
                detailFloorSpan.textContent = item.floor || '-';
                selectedRoomDetailsDiv.classList.remove('hidden');
                if (item.guest) {
                    guestNameInput.value = item.guest.name || '';
                    guestIdInput.value = item.guest.id || '';
                    guestPhoneInput.value = item.guest.phone || '';
                    guestCountryCodeInput.value = item.guest.country_code || '';
                }
                hideRoomSuggestions();
            });
            roomSuggestions.appendChild(option);
        });
        roomSuggestions.classList.remove('hidden');
    }
    function fetchRoomGuestLookup(query) {
        const url = `{% url 'dashboard:api_room_guest_lookup' %}?q=${encodeURIComponent(query)}`;
        fetch(url).then(res => res.json()).then(data => data.success ? renderRoomSuggestions(data.results || []) : hideRoomSuggestions()).catch(() => hideRoomSuggestions());
    }
    if (roomNumberInput) {
        roomNumberInput.addEventListener('input', () => {
            const query = roomNumberInput.value.trim();
            clearRoomDetails();
            if (query.length < 1) { hideRoomSuggestions(); return; }
            fetchRoomGuestLookup(query);
        });
        roomNumberInput.addEventListener('focus', () => {
            const query = roomNumberInput.value.trim();
            if (query.length >= 1) fetchRoomGuestLookup(query);
        });
    }
    document.addEventListener('click', (e) => {
        if (!roomNumberInput.contains(e.target) && !roomSuggestions.contains(e.target)) hideRoomSuggestions();
    });

    // File upload preview
    const attachmentInput = document.getElementById('attachments');
    const previewList = document.getElementById('attachmentPreview');
    let selectedFiles = new DataTransfer();
    function renderPreview() {
        previewList.innerHTML = '';
        Array.from(selectedFiles.files).forEach((file, index) => {
            const li = document.createElement('li');
            li.className = "flex items-center justify-between gap-3 p-2 border rounded-lg";
            li.innerHTML = `
                <div class="flex items-center gap-2">
                    <span>ðŸ“Ž</span>
                    <span class="text-sm">${file.name} <span class="text-gray-500">(${(file.size / 1024 / 1024).toFixed(2)} MB)</span></span>
                </div>
                <button type="button" class="text-red-500 hover:text-red-700 text-sm font-medium" data-index="${index}">âœ•</button>
            `;
            previewList.appendChild(li);
        });
    }
    if (attachmentInput) {
        attachmentInput.addEventListener('change', (e) => {
            Array.from(e.target.files).forEach(file => selectedFiles.items.add(file));
            attachmentInput.files = selectedFiles.files;
            renderPreview();
        });
    }
    previewList.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            const removeIndex = parseInt(e.target.dataset.index, 10);
            const newDataTransfer = new DataTransfer();
            Array.from(selectedFiles.files).forEach((file, index) => index !== removeIndex ? newDataTransfer.items.add(file) : null);
            selectedFiles = newDataTransfer;
            attachmentInput.files = selectedFiles.files;
            renderPreview();
        }
    });

    // Submit create ticket
    const submitTicketBtn = document.getElementById('submitCreateTicket');
    if (submitTicketBtn) { 
        submitTicketBtn.addEventListener('click', () => {
            const guestName = document.getElementById('guestName').value.trim();
            const roomNumber = document.getElementById('roomNumber').value.trim();
            const department = document.getElementById('department').value;
            const category = selectedRequestType ? selectedRequestType.name : '';
            const description = document.getElementById('description').value.trim();
            const locationId = document.getElementById('locationId').value;

            if (!locationId) {
                showToast("Please select room number from dropdown", "error");
                return;
            }
            if ( !roomNumber || !department || !category || !selectedPriority) {
                showToast('Please fill all required fields: Room Number, Department, Request Type, Priority', 'error');
                return;
            }

            const formData = new FormData();
            const phone = document.getElementById('guestPhone').value;
            const countryCode = document.getElementById('guestCountryCode').value;
            const guestIdRaw = document.getElementById('guestId').value;

            formData.append('guest_name', guestName);
            formData.append('room_number', roomNumber);
            formData.append('department', department);
            formData.append('category', category);
            formData.append('priority', selectedPriority);
            formData.append('description', description);
            formData.append("location_id", locationId);
            // formData.append('requester_user', {{ request.user.id }}); // Auto assign current user as requester

            if (guestIdRaw && !isNaN(guestIdRaw)) formData.append('guest_id', parseInt(guestIdRaw, 10));
            if (phone) formData.append('phone_number', countryCode ? `${countryCode}${phone}` : phone);
            if (selectedFiles.files.length > 0) {
                for (let i = 0; i < selectedFiles.files.length; i++) formData.append('attachments', selectedFiles.files[i]);
            }

            fetch('{% url "dashboard:api_create_ticket" %}', {
                method: 'POST',
                headers: { 'X-CSRFToken': getCookie('csrftoken') },
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast('Ticket created successfully!', 'success');
                    selectedPriority = '';
                    selectedRequestType = null;
                    selectedFiles = new DataTransfer();
                    document.querySelector('#createTicketModal form').reset();
                    document.querySelectorAll('.priority-btn').forEach(btn => btn.classList.remove('ring-2', 'ring-offset-2', 'ring-sky-500'));
                    closeCreateTicketModal();
                    location.reload();
                } else {
                    showToast(data.error || 'Failed to create ticket', 'error');
                }
            })
            .catch(err => {
                console.error(err);
                showToast('Server error. Please try again.', 'error');
            });
        });
    }
});
</script>
{% endblock extra_js %}
