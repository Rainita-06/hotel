{% extends "dashboard/base_dashboard.html" %}
{% load static %}

{% block content %}
<!-- Add AOS CSS for animations -->
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

<header class="w-full bg-white border-b border-gray-200" data-aos="fade-down" data-aos-duration="600">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
    <div class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
      <div class="flex-1">
        <div class="flex items-center gap-2 text-sm">
          <span class="text-gray-600 font-normal font-['Inter']">
            {% if breadcrumb_section %} {{ breadcrumb_section }} {% elif crumb_section %} {{ crumb_section }} {% else %} Admin {% endif %}
          </span>
          <span class="text-gray-400">/</span>
          <span class="text-gray-900 font-medium font-['Inter']">
            {% if breadcrumb_title %} {{ breadcrumb_title }} {% elif crumb_title %} {{ crumb_title }} {% else %} Users {% endif %}
          </span>
        </div>
        <h1 class="mt-2 text-2xl font-bold text-gray-900 font-['Inter']">
          {% if page_title %} {{ page_title }} {% elif title %} {{ title }} {% else %} Manage Users {% endif %}
        </h1>
        <p class="mt-1 text-sm text-gray-600 font-normal font-['Inter']">
          {% if page_subtitle %} {{ page_subtitle }} {% elif subtitle %} {{ subtitle }} {% else %} Manage user accounts, roles, and permissions across your property. {% endif %}
        </p>
      </div>

      <div class="flex items-center gap-4">
        <div class="relative">
          <input id="quick-search" type="text" name="q" placeholder="{{ search_placeholder|default:'Search users...' }}"
                 class="w-64 h-10 pl-10 pr-3 rounded-lg border border-gray-200 bg-white text-base text-gray-900 placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 font-['Inter']" />
          <div class="absolute inset-y-0 left-0 flex items-center pl-3">
            <img src="{% static 'images/dashboard/search.svg' %}" alt="Search" class="w-5 h-5" />
          </div>
        </div>

        <button id="primaryActionBtn" type="button"
                class="inline-flex items-center gap-2 h-10 px-4 rounded-lg bg-sky-600 text-white text-base font-medium font-['Inter'] hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-colors">
          <img src="{% static 'images/sidebar/settings.svg' %}" alt="Plus" class="w-5 h-5" />
          <span id="primaryActionLabel">{{ primary_label|default:"Create User" }}</span>
        </button>

        <!-- Test button for debugging (kept hidden) -->
        <button id="testCreateGroupBtn" type="button" onclick="showModal('createGroupModal')" style="display: none;">Test Create Group</button>
      </div>
    </div>
  </div>

  <div class="w-full bg-white border-t border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-start gap-8 border-b border-gray-200 -mb-px">
        <a href="{% url 'dashboard:manage_users_all' %}"
           class="py-4 px-1 inline-flex items-center gap-2 border-b-2 text-sm font-medium {% if active_tab|default:'all' == 'all' %}border-sky-600 text-sky-600{% else %}border-transparent text-gray-600 hover:text-gray-800{% endif %}">
          All Users
        </a>
        <a href="{% url 'dashboard:manage_users_groups' %}"
           class="py-4 px-1 inline-flex items-center gap-2 border-b-2 text-sm font-medium {% if active_tab == 'groups' %}border-sky-600 text-sky-600{% else %}border-transparent text-gray-600 hover:text-gray-800{% endif %}">
          Groups
        </a>
        <a href="{% url 'dashboard:manage_users_profiles' %}"
           class="py-4 px-1 inline-flex items-center gap-2 border-b-2 text-sm font-medium {% if active_tab == 'profiles' %}border-sky-600 text-sky-600{% else %}border-transparent text-gray-600 hover:text-gray-800{% endif %}">
          User Profiles
        </a>
        <a href="{% url 'dashboard:departments' %}"
           class="py-4 px-1 inline-flex items-center gap-2 border-b-2 text-sm font-medium {% if active_tab == 'departments' %}border-sky-600 text-sky-600{% else %}border-transparent text-gray-600 hover:text-gray-800{% endif %}">
          Departments
        </a>
      </div>
    </div>
  </div>
</header>

<main class="w-full" data-aos="fade-up" data-aos-delay="200">
  <div class="max-w-7xl mx-auto px-0 py-0">
    {% if active_tab == 'departments' %}
      {% include 'dashboard/departments_list.html' %}
    {% else %}
      {% block manage_content %}{% endblock manage_content %}
    {% endif %}
  </div>
</main>

<!-- Create Group Modal -->
<div id="createGroupModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/60 backdrop-blur-sm transition-opacity duration-300 opacity-0" onclick="closeModal('createGroupModal')">
  <div class="w-full max-w-md rounded-lg bg-white shadow-xl transform transition-all duration-300 scale-95 opacity-0" onclick="event.stopPropagation()">
    <div class="flex items-start justify-between p-5 border-b">
      <h3 class="text-lg font-semibold text-gray-900">Create Group</h3>
      <button onclick="closeModal('createGroupModal')" class="rounded-full p-1 text-gray-500 hover:bg-gray-100 transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
      </button>
    </div>
    <form id="createGroupForm" class="p-6 space-y-4 overflow-y-auto max-h-[70vh]">
      {% csrf_token %}
      <div>
        <label class="block text-sm font-medium text-gray-700">Group Name</label>
        <input type="text" id="createGroupName" name="name" class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="e.g. Floor Supervisors" required />
        <p class="mt-1 text-xs text-gray-500">Enter a descriptive name for your group</p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Description</label>
        <textarea id="createGroupDescription" name="description" class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Optional description"></textarea>
        <p class="mt-1 text-xs text-gray-500">Provide a brief description of the group's purpose</p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Department (optional)</label>
        <select id="createGroupDepartment" name="department" class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500">
          <option value="">None</option>
        </select>
        <p class="mt-1 text-xs text-gray-500">Associate this group with a department (optional)</p>
      </div>
      <div id="createGroupError" class="text-sm text-red-600 hidden"></div>
    </form>
    <div class="flex items-center justify-end gap-3 p-5 border-t bg-gray-50 rounded-b-lg">
      <button type="button" class="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-800 hover:bg-gray-50" onclick="closeModal('createGroupModal')">Cancel</button>
      <button id="createGroupSubmit" type="submit" form="createGroupForm" class="rounded-md bg-sky-600 px-4 py-2 text-sm font-medium text-white hover:bg-sky-700">Create Group</button>
    </div>
  </div>
</div>

<!-- Create User Modal -->
<div id="inviteUserModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/60 backdrop-blur-sm transition-opacity duration-300 opacity-0" onclick="closeModal('inviteUserModal')">
  <div class="w-full max-w-md rounded-lg bg-white shadow-xl transform transition-all duration-300 scale-95 opacity-0" onclick="event.stopPropagation()">
    <div class="flex items-start justify-between p-5 border-b">
      <h3 class="text-lg font-semibold text-gray-900">Create User</h3>
      <button onclick="closeModal('inviteUserModal')" class="rounded-full p-1 text-gray-500 hover:bg-gray-100 transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
      </button>
    </div>
    <form id="inviteUserForm" class="p-6 space-y-4 overflow-y-auto max-h-[70vh]" enctype="multipart/form-data">
      {% csrf_token %}
      <div>
        <label class="block text-sm font-medium text-gray-700">Full Name</label>
        <input type="text" id="inviteUserName" name="full_name" class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="e.g. John Doe" required />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Email</label>
        <input type="email" id="inviteUserEmail" name="email" class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="e.g. john@example.com" required />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Username</label>
        <input type="text" id="inviteUserUsername" name="username" class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="e.g. johndoe" required />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Password</label>
        <input type="password" id="inviteUserPassword" name="password" class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Enter password" />
        <p class="mt-1 text-xs text-gray-500">Leave blank to auto-generate a password</p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Phone Number</label>
        <input type="text" id="inviteUserPhone" name="phone" class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="e.g. +1234567890" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Profile Picture</label>
        <input type="file" id="inviteUserProfilePicture" name="profile_picture" accept="image/*" class="mt-1 w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100" />
        <p class="mt-1 text-xs text-gray-500">Upload a JPG, JPEG, PNG, or GIF image (max 5MB)</p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Department</label>
        <select id="inviteUserDepartment" name="department" class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500">
          <option value="">Select Department</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Role</label>
        <select id="inviteUserRole" name="role" class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500">
          <option value="">Select Role</option>
        </select>
      </div>
      <div id="inviteUserError" class="text-sm text-red-600 hidden"></div>
    </form>
    <div class="flex items-center justify-end gap-3 p-5 border-t bg-gray-50 rounded-b-lg">
      <button type="button" class="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-800 hover:bg-gray-50" onclick="closeModal('inviteUserModal')">Cancel</button>
      <button id="inviteUserSubmit" type="submit" form="inviteUserForm" class="rounded-md bg-sky-600 px-4 py-2 text-sm font-medium text-white hover:bg-sky-700">Create User</button>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div id="toastNotification" class="fixed top-5 right-5 z-50 flex items-center rounded-lg px-4 py-3 text-white shadow-lg transform transition-all duration-300 translate-x-full opacity-0">
  <span id="toastMessage"></span>
</div>

{% endblock content %}

{% block extra_js %}
<!-- Add AOS JS library -->
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>
  // Expose active tab for client logic
  window.manageUsersActiveTab = "{{ active_tab|default:'all'|escapejs }}";

  document.addEventListener('DOMContentLoaded', function() {
    // Initialize AOS animations
    AOS.init({
      once: true,
      disable: 'phone'
    });

    const tab = String(window.manageUsersActiveTab || 'all').trim().toLowerCase();

    // Set primary action button label
    const label = document.getElementById('primaryActionLabel');
    if (label) {
      if (tab === 'groups') {
        label.textContent = 'Create Group';
      } else if (tab === 'departments') {
        label.textContent = 'Add Department';
      } else {
        label.textContent = 'Create User';
      }
    }
    
    // Add event listeners
    document.getElementById('primaryActionBtn')?.addEventListener('click', () => openPrimaryAction());
    document.getElementById('createGroupForm')?.addEventListener('submit', (e) => submitCreateGroup(e));
    document.getElementById('inviteUserForm')?.addEventListener('submit', (e) => submitInviteUser(e));
  });

  // --- MODAL & TOAST LOGIC (FIXED FOR PROPER CENTERING) ---

  function showModal(id) {
    const modal = document.getElementById(id);
    if (!modal) return;
    const modalContent = modal.querySelector('div[onclick="event.stopPropagation()"]');
    
    // Remove hidden class and add flex to ensure proper centering
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    
    // Use a tiny timeout to allow the browser to render the modal before starting the transition
    requestAnimationFrame(() => {
      modal.classList.remove('opacity-0');
      if (modalContent) {
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
      }
    });
  }

  function closeModal(id) {
    const modal = document.getElementById(id);
    if (!modal) return;
    const modalContent = modal.querySelector('div[onclick="event.stopPropagation()"]');

    modal.classList.add('opacity-0');
    if (modalContent) {
      modalContent.classList.remove('scale-100', 'opacity-100');
      modalContent.classList.add('scale-95', 'opacity-0');
    }
    
    // Wait for the animation to finish before hiding the element
    setTimeout(() => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }, 300); // Must match the duration in the class list (duration-300)
  }
  
  function showToast(message, type = 'success') {
    const toast = document.getElementById('toastNotification');
    const toastMessage = document.getElementById('toastMessage');
    if (!toast || !toastMessage) return;

    toastMessage.textContent = message;
    
    // Reset classes
    toast.classList.remove('bg-green-500', 'bg-red-500');
    if (type === 'error') {
      toast.classList.add('bg-red-500');
    } else {
      toast.classList.add('bg-green-500');
    }
    
    // Animate in
    toast.classList.remove('translate-x-full', 'opacity-0');

    // Automatically hide after 3 seconds
    setTimeout(() => {
      toast.classList.add('translate-x-full', 'opacity-0');
    }, 3000);
  }

  // --- APPLICATION LOGIC ---
  
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  
  function openPrimaryAction() {
    const tab = String(window.manageUsersActiveTab || 'all').trim().toLowerCase();
    if (tab === 'groups') {
      const deptSelect = document.getElementById('createGroupDepartment');
      if (deptSelect) {
        fetch('{% url "dashboard:api_manage_users_filters" %}', { headers: { 'Accept': 'application/json' }})
          .then(r => r.ok ? r.json() : Promise.reject(r))
          .then(data => {
            deptSelect.innerHTML = '<option value="">None</option>';
            if (Array.isArray(data.departments)) {
              data.departments.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d;
                opt.textContent = d;
                deptSelect.appendChild(opt);
              });
            }
          })
          .catch(err => console.error('Error populating group departments:', err));
      }
      showModal('createGroupModal');
      return;
    }
    if (tab === 'departments') {
      if (typeof openAddDepartmentModal === 'function') {
        openAddDepartmentModal();
        return;
      }
    }
    openInviteUserModal();
  }

  function openInviteUserModal() {
    // Reset form and error states
    const form = document.getElementById('inviteUserForm');
    if (form) form.reset();
    
    const deptSelect = document.getElementById('inviteUserDepartment');
    const roleSelect = document.getElementById('inviteUserRole');
    const errorEl = document.getElementById('inviteUserError');
    
    if (deptSelect) deptSelect.innerHTML = '<option value="">Select Department</option>';
    if (roleSelect) roleSelect.innerHTML = '<option value="">Select Role</option>';
    if (errorEl) errorEl.classList.add('hidden');

    fetch('{% url "dashboard:api_manage_users_filters" %}', { headers: { 'Accept': 'application/json' }})
      .then(response => response.ok ? response.json() : Promise.reject(response))
      .then(data => {
        // Populate departments
        if (deptSelect) {
          deptSelect.innerHTML = '<option value="">Select Department</option>';
          if (Array.isArray(data.departments)) {
            data.departments.forEach(dept => {
              const option = document.createElement('option');
              option.value = dept;
              option.textContent = dept;
              deptSelect.appendChild(option);
            });
          }
        }
        
        // Populate roles
        if (roleSelect) {
          roleSelect.innerHTML = '<option value="">Select Role</option>';
          const roles = Array.isArray(data.roles) ? data.roles : ['Admins', 'Staff', 'Users'];
          roles.forEach(role => {
            const option = document.createElement('option');
            option.value = role;
            option.textContent = role;
            roleSelect.appendChild(option);
          });
        }
      })
      .catch(err => console.error('Error loading filters for Create User:', err))
      .finally(() => showModal('inviteUserModal'));
  }

  function submitCreateGroup(e) {
    e.preventDefault();
    const btn = document.getElementById('createGroupSubmit');
    const form = document.getElementById('createGroupForm');
    const errorEl = document.getElementById('createGroupError');
    const formData = new FormData(form);

    const name = formData.get('name').trim();
    if (!name) {
      errorEl.textContent = 'Group name is required.';
      errorEl.classList.remove('hidden');
      return;
    }

    btn.disabled = true;
    btn.textContent = 'Creating...';
    errorEl.classList.add('hidden');
    
    // Create URL-encoded form data for this specific request
    const body = new URLSearchParams();
    for (const pair of formData.entries()) {
        body.append(pair[0], pair[1]);
    }

    fetch('{% url "dashboard:group_create" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
        'Accept': 'application/json'
      },
      body: body
    })
    .then(async response => {
      const payload = await response.json().catch(() => ({}));
      if (!response.ok) {
        const msg = payload.errors ? Object.values(payload.errors).flat().join(', ') : payload.detail || 'Failed to create group.';
        throw new Error(msg);
      }
      return payload;
    })
    .then(data => {
      closeModal('createGroupModal');
      showToast('Group created successfully!', 'success');
      setTimeout(() => { window.location.reload(); }, 700);
    })
    .catch(err => {
      errorEl.textContent = err.message;
      errorEl.classList.remove('hidden');
    })
    .finally(() => {
      btn.disabled = false;
      btn.textContent = 'Create Group';
    });
  }

  function submitInviteUser(e) {
    e.preventDefault();
    const btn = document.getElementById('inviteUserSubmit');
    const form = document.getElementById('inviteUserForm');
    const errorEl = document.getElementById('inviteUserError');
    const formData = new FormData(form);

    // Manual validation for key fields
    if (!formData.get('username') || !formData.get('email') || !formData.get('full_name')) {
        errorEl.textContent = 'Please fill in all required fields (Full Name, Email, Username).';
        errorEl.classList.remove('hidden');
        return;
    }
    
    // File validation
    const profilePicture = formData.get('profile_picture');
    if (profilePicture && profilePicture.size > 0) {
        if (profilePicture.size > 5 * 1024 * 1024) { // 5MB
            errorEl.textContent = 'Image file is too large. Maximum size is 5MB.';
            errorEl.classList.remove('hidden');
            return;
        }
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
        if (!validTypes.includes(profilePicture.type)) {
            errorEl.textContent = 'Please upload a valid image file (JPG, PNG, GIF).';
            errorEl.classList.remove('hidden');
            return;
        }
    }

    btn.disabled = true;
    btn.textContent = 'Creating...';
    errorEl.classList.add('hidden');

    fetch('{% url "dashboard:user_create" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
        'Accept': 'application/json'
      },
      body: formData
    })
    .then(async response => {
      const payload = await response.json().catch(() => ({}));
      if (!response.ok) {
        const msg = payload.errors ? Object.values(payload.errors).flat().join(', ') : payload.detail || 'Failed to create user.';
        throw new Error(msg);
      }
      return payload;
    })
    .then(data => {
      closeModal('inviteUserModal');
      showToast('User created successfully!', 'success');
      setTimeout(() => { window.location = '{% url "dashboard:manage_users_all" %}'; }, 700);
    })
    .catch(err => {
      errorEl.textContent = err.message;
      errorEl.classList.remove('hidden');
    })
    .finally(() => {
      btn.disabled = false;
      btn.textContent = 'Create User';
    });
  }

</script>
{% endblock extra_js %}