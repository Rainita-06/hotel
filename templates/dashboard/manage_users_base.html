{% extends "dashboard/base_dashboard.html" %}
{% load static %}

{% block content %}

<header class="w-full bg-white border-b border-gray-200">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
    <div class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
      <div class="flex-1">
        <div class="flex items-center gap-2 text-sm">
          <span class="text-gray-600 font-normal font-['Inter']">
            {% if breadcrumb_section %} {{ breadcrumb_section }} {% elif crumb_section %} {{ crumb_section }} {% else %} Admin {% endif %}
          </span>
          <span class="text-gray-400">/</span>
          <span class="text-gray-900 font-medium font-['Inter']">
            {% if breadcrumb_title %} {{ breadcrumb_title }} {% elif crumb_title %} {{ crumb_title }} {% else %} Users {% endif %}
          </span>
        </div>
        <h1 class="mt-2 text-2xl font-bold text-gray-900 font-['Inter']">
          {% if page_title %} {{ page_title }} {% elif title %} {{ title }} {% else %} Manage Users {% endif %}
        </h1>
        <p class="mt-1 text-sm text-gray-600 font-normal font-['Inter']">
          {% if page_subtitle %} {{ page_subtitle }} {% elif subtitle %} {{ subtitle }} {% else %} Manage user accounts, roles, and permissions across your property. {% endif %}
        </p>
      </div>

      <div class="flex items-center gap-4">
        <div class="relative">
          <input id="quick-search" type="text" name="q" placeholder="{{ search_placeholder|default:'Search users...' }}"
                 class="w-64 h-10 pl-10 pr-3 rounded-lg border border-gray-200 bg-white text-base text-gray-900 placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 font-['Inter']" />
          <div class="absolute inset-y-0 left-0 flex items-center pl-3">
            <img src="{% static 'images/dashboard/search.svg' %}" alt="Search" class="w-5 h-5" />
          </div>
        </div>

        <button id="primaryActionBtn" type="button"
           class="inline-flex items-center gap-2 h-10 px-4 rounded-lg bg-sky-600 text-white text-base font-medium font-['Inter'] hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">
          <img src="{% static 'images/sidebar/settings.svg' %}" alt="Plus" class="w-5 h-5" />
          <span id="primaryActionLabel">{{ primary_label|default:"Create User" }}</span>
        </button>

        <!-- Test button for debugging (kept hidden) -->
        <button id="testCreateGroupBtn" type="button" onclick="showModal('createGroupModal', true)" style="display: none;">Test Create Group</button>
      </div>
    </div>
  </div>

  <div class="w-full bg-white border-t border-gray-200">
    <div class="max-w-7xl mx-auto px-0">
      <div class="w-[1184px] mx-auto h-14 relative bg-white border-b border-gray-200">
        <div class="w-[1136px] h-14 left-[24px] top-0 absolute inline-flex justify-start items-start gap-8">
          <a href="{% url 'dashboard:manage_users_all' %}"
             class="w-20 self-stretch relative bg-transparent border-b-2 {% if active_tab|default:'all' == 'all' %}border-sky-600{% else %}border-transparent{% endif %}">
            <span class="w-full h-5 absolute left-[4px] top-[17px] text-center text-sm font-medium font-['Inter'] {% if active_tab|default:'all' == 'all' %}text-sky-600{% else %}text-gray-600{% endif %}">
              All Users
            </span>
          </a>
          <a href="{% url 'dashboard:manage_users_groups' %}"
             class="w-14 self-stretch relative bg-transparent border-b-2 {% if active_tab == 'groups' %}border-sky-600{% else %}border-transparent{% endif %}">
            <span class="w-full h-5 absolute left-[4px] top-[17px] text-center text-sm font-medium font-['Inter'] {% if active_tab == 'groups' %}text-sky-600{% else %}text-gray-600{% endif %}">
              Groups
            </span>
          </a>
          <a href="{% url 'dashboard:manage_users_profiles' %}"
             class="w-28 self-stretch relative bg-transparent border-b-2 {% if active_tab == 'profiles' %}border-sky-600{% else %}border-transparent{% endif %}">
            <span class="w-full h-5 absolute left-[4px] top-[17px] text-center text-sm font-medium font-['Inter'] {% if active_tab == 'profiles' %}text-sky-600{% else %}text-gray-600{% endif %}">
              User Profiles
            </span>
          </a>
          <a href="{% url 'dashboard:departments' %}"
             class="w-28 self-stretch relative bg-transparent border-b-2 {% if active_tab == 'departments' %}border-sky-600{% else %}border-transparent{% endif %}">
            <span class="w-full h-5 absolute left-[4px] top-[17px] text-center text-sm font-medium font-['Inter'] {% if active_tab == 'departments' %}text-sky-600{% else %}text-gray-600{% endif %}">
              Departments
            </span>
          </a>
        </div>
      </div>
    </div>
  </div>
</header>

<main class="w-full">
  <div class="max-w-7xl mx-auto px-0 py-0">
    {% if active_tab == 'departments' %}
      {% include 'dashboard/departments_list.html' %}
    {% else %}
      {% block manage_content %}{% endblock manage_content %}
    {% endif %}
  </div>
</main>

<!-- Create Group Modal -->
<div id="createGroupModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50">
  <div class="w-full max-w-md rounded-lg bg-white p-6" onclick="event.stopPropagation()">
    <div class="flex items-start justify-between">
      <h3 class="text-lg font-semibold">Create Group</h3>
      <button onclick="closeModal('createGroupModal')" class="rounded p-1 text-gray-500 hover:bg-gray-100">✕</button>
    </div>
    <form id="createGroupForm" class="mt-4 space-y-4">
      {% csrf_token %}
      <div>
        <label class="block text-sm font-medium text-gray-700">Group Name</label>
        <input type="text" id="createGroupName" name="name" class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="e.g. Floor Supervisors" required />
        <p class="mt-1 text-xs text-gray-500">Enter a descriptive name for your group</p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Description</label>
        <textarea id="createGroupDescription" name="description" class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Optional description"></textarea>
        <p class="mt-1 text-xs text-gray-500">Provide a brief description of the group's purpose</p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Department (optional)</label>
        <select id="createGroupDepartment" name="department" class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500">
          <option value="">None</option>
        </select>
        <p class="mt-1 text-xs text-gray-500">Associate this group with a department (optional)</p>
      </div>
      <div class="flex items-center justify-end gap-2">
        <button type="button" class="rounded-md border border-gray-200 bg-white px-3 py-1.5 text-sm text-gray-800 hover:bg-gray-50" onclick="closeModal('createGroupModal')">Cancel</button>
        <button id="createGroupSubmit" type="submit" class="rounded-md bg-sky-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-sky-700">Create Group</button>
      </div>
      <div id="createGroupError" class="text-sm text-red-600 hidden"></div>
    </form>
  </div>
</div>

<!-- Create User Modal -->
<div id="inviteUserModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50">
  <div class="w-full max-w-md rounded-lg bg-white p-6" onclick="event.stopPropagation()">
    <div class="flex items-start justify-between">
      <h3 class="text-lg font-semibold">Create User</h3>
      <button onclick="closeModal('inviteUserModal')" class="rounded p-1 text-gray-500 hover:bg-gray-100">✕</button>
    </div>
    <form id="inviteUserForm" class="mt-4 space-y-4" enctype="multipart/form-data">
      {% csrf_token %}
      <div>
        <label class="block text-sm font-medium text-gray-700">Full Name</label>
        <input type="text" id="inviteUserName" class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="e.g. John Doe" required />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Email</label>
        <input type="email" id="inviteUserEmail" class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="e.g. john@example.com" required />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Phone Number</label>
        <input type="text" id="inviteUserPhone" class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="e.g. +1234567890" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Profile Picture</label>
        <input type="file" id="inviteUserProfilePicture" accept="image/*" class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500" />
        <p class="mt-1 text-xs text-gray-500">Upload a JPG, JPEG, PNG, or GIF image (max 5MB)</p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Department</label>
        <select id="inviteUserDepartment" class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500">
          <option value="">Select Department</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Role</label>
        <select id="inviteUserRole" class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500">
          <option value="">Select Role</option>
        </select>
      </div>
      <div class="flex items-center justify-end gap-2">
        <button type="button" class="rounded-md border border-gray-200 bg-white px-3 py-1.5 text-sm text-gray-800 hover:bg-gray-50" onclick="closeModal('inviteUserModal')">Cancel</button>
        <button id="inviteUserSubmit" type="submit" class="rounded-md bg-sky-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-sky-700">Create User</button>
      </div>
      <div id="inviteUserError" class="text-sm text-red-600 hidden"></div>
    </form>
  </div>
</div>

<!-- Toast Notification -->
<div id="toastNotification" class="fixed top-4 right-4 z-50 hidden items-center rounded-lg bg-green-500 px-4 py-2 text-white shadow-lg">
  <span id="toastMessage"></span>
</div>

{% endblock content %}

{% block extra_js %}
<script>
  // Expose active tab for client logic (properly quoted and escaped to avoid JS errors)
  window.manageUsersActiveTab = "{{ active_tab|default:'all'|escapejs }}";
  console.log('Active tab set to:', window.manageUsersActiveTab);
  console.log('Active tab type:', typeof window.manageUsersActiveTab);

  document.addEventListener('DOMContentLoaded', function() {
    const tabRaw = window.manageUsersActiveTab || 'all';
    const tab = String(tabRaw).trim().toLowerCase();
    console.log('DOM loaded, active tab:', tab);

    // Set primary action button label based on active tab
    const label = document.getElementById('primaryActionLabel');
    if (label) {
      if (tab === 'groups') {
        label.textContent = 'Create Group';
      } else if (tab === 'departments') {
        label.textContent = 'Add Department';
      } else {
        label.textContent = 'Create User';
      }
    }
    
    // Add event listener to primary action button
    const primaryBtn = document.getElementById('primaryActionBtn');
    if (primaryBtn) {
      primaryBtn.addEventListener('click', function() {
        openPrimaryAction();
      });
    }
    
    // Add event listener to create group form
    const createGroupForm = document.getElementById('createGroupForm');
    if (createGroupForm) {
      createGroupForm.addEventListener('submit', function(e) {
        submitCreateGroup(e);
      });
    }
    
    // Add event listener to invite user form
    const inviteUserForm = document.getElementById('inviteUserForm');
    if (inviteUserForm) {
      inviteUserForm.addEventListener('submit', function(e) {
        submitInviteUser(e);
      });
    }
  });

  // Helpers
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function showModal(id, open) {
    const el = document.getElementById(id);
    if (!el) return;
    if (open) {
      el.classList.remove('hidden');
      el.classList.add('flex');
    } else {
      el.classList.add('hidden');
      el.classList.remove('flex');
    }
  }
  function closeModal(id) { showModal(id, false); }

  // Close modals when clicking on backdrop
  document.getElementById('inviteUserModal')?.addEventListener('click', () => closeModal('inviteUserModal'));
  document.getElementById('createGroupModal')?.addEventListener('click', () => closeModal('createGroupModal'));

  function showToast(message, type = 'success') {
    const toast = document.getElementById('toastNotification');
    const toastMessage = document.getElementById('toastMessage');
    toastMessage.textContent = message;
    toast.classList.remove('hidden');
    toast.classList.add('flex');
    if (type === 'error') {
      toast.classList.remove('bg-green-500');
      toast.classList.add('bg-red-500');
    } else {
      toast.classList.remove('bg-red-500');
      toast.classList.add('bg-green-500');
    }
    setTimeout(() => {
      toast.classList.add('hidden');
      toast.classList.remove('flex');
    }, 3000);
  }

  document.getElementById('toastNotification')?.addEventListener('click', () => {
    const toast = document.getElementById('toastNotification');
    toast.classList.add('hidden');
    toast.classList.remove('flex');
  });

  // Primary action dispatcher
  function openPrimaryAction() {
    const tab = String(window.manageUsersActiveTab || 'all').trim().toLowerCase();
    if (tab === 'groups') {
      const deptSelect = document.getElementById('createGroupDepartment');
      if (deptSelect) {
        fetch('{% url "dashboard:api_manage_users_filters" %}', { headers: { 'Accept': 'application/json' }})
          .then(async r => {
            if (!r.ok) {
              const text = await r.text().catch(() => '');
              console.error('Failed to load filters for groups. Status:', r.status, text);
              throw new Error('Network error loading filters');
            }
            return r.json();
          })
          .then(data => {
            deptSelect.innerHTML = '<option value="">None</option>';
            if (Array.isArray(data.departments)) {
              data.departments.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d;
                opt.textContent = d;
                deptSelect.appendChild(opt);
              });
            }
          })
          .catch(err => console.error('Error populating group departments:', err));
      }
      showModal('createGroupModal', true);
      return;
    }
    if (tab === 'departments') {
      if (typeof openAddDepartmentModal === 'function') {
        openAddDepartmentModal();
        return;
      }
    }
    openInviteUserModal();
  }

  // Open Create User Modal
  function openInviteUserModal() {
    // Reset form
    document.getElementById('inviteUserName').value = '';
    document.getElementById('inviteUserEmail').value = '';
    document.getElementById('inviteUserPhone').value = '';
    document.getElementById('inviteUserDepartment').innerHTML = '<option value="">Select Department</option>';
    document.getElementById('inviteUserRole').innerHTML = '<option value="">Select Role</option>';
    document.getElementById('inviteUserError').classList.add('hidden');

    // Populate dropdowns
    fetch('{% url "dashboard:api_manage_users_filters" %}', { headers: { 'Accept': 'application/json' }})
      .then(async response => {
        if (!response.ok) {
          const text = await response.text().catch(() => '');
          console.error('Failed to load filters. Status:', response.status, text);
          throw new Error('Failed to load filters');
        }
        return response.json();
      })
      .then(data => {
        // Departments
        const deptSelect = document.getElementById('inviteUserDepartment');
        deptSelect.innerHTML = '<option value="">Select Department</option>';
        if (Array.isArray(data.departments)) {
          data.departments.forEach(dept => {
            const option = document.createElement('option');
            option.value = dept;
            option.textContent = dept;
            deptSelect.appendChild(option);
          });
        }
        // Roles
        const roleSelect = document.getElementById('inviteUserRole');
        roleSelect.innerHTML = '<option value="">Select Role</option>';
        const roles = Array.isArray(data.roles) ? data.roles : ['Admins', 'Staff', 'Users'];
        roles.forEach(role => {
          const option = document.createElement('option');
          option.value = role;
          option.textContent = role;
          roleSelect.appendChild(option);
        });
      })
      .catch(err => {
        console.error('Error loading filters for Create User:', err);
        // Fallbacks
        const deptSelect = document.getElementById('inviteUserDepartment');
        deptSelect.innerHTML = `
          <option value="">Select Department</option>
          <option value="Housekeeping">Housekeeping</option>
          <option value="Front Office">Front Office</option>
          <option value="Food &amp; Beverage">Food &amp; Beverage</option>
          <option value="Maintenance">Maintenance</option>
          <option value="Security">Security</option>
        `;
        const roleSelect = document.getElementById('inviteUserRole');
        roleSelect.innerHTML = `
          <option value="">Select Role</option>
          <option value="Admins">Admins</option>
          <option value="Staff">Staff</option>
          <option value="Users">Users</option>
        `;
      })
      .finally(() => showModal('inviteUserModal', true));
  }

  // Create Group submit
  function submitCreateGroup(e) {
    e.preventDefault();
    const btn = document.getElementById('createGroupSubmit');
    const name = document.getElementById('createGroupName').value.trim();
    const description = document.getElementById('createGroupDescription').value.trim();
    const dept = document.getElementById('createGroupDepartment').value;
    const errorEl = document.getElementById('createGroupError');

    if (!name) {
      errorEl.textContent = 'Group name is required.';
      errorEl.classList.remove('hidden');
      return;
    }

    btn.disabled = true;
    errorEl.classList.add('hidden');

    const form = new URLSearchParams();
    form.set('name', name);
    form.set('description', description);
    if (dept) form.set('department', dept);

    const csrfTokenElement = document.querySelector('#createGroupForm input[name=csrfmiddlewaretoken]');
    const csrfToken = csrfTokenElement?.value || getCookie('csrftoken');

    fetch('{% url "dashboard:group_create" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrfToken,
        'Accept': 'application/json'
      },
      body: form.toString()
    })
    .then(response => response)
    .then(async response => {
      const contentType = response.headers.get('content-type') || '';
      const payload = contentType.includes('application/json')
        ? await response.json().catch(() => ({}))
        : { detail: await response.text().catch(() => '') };

      if (!response.ok || payload.success === false) {
        const msg = payload.errors ? Object.values(payload.errors).flat().join(', ') :
                  payload.detail || 'Failed to create group.';
        throw new Error(msg);
      }

      return payload;
    })
    .then(data => {
      btn.disabled = false;
      closeModal('createGroupModal');
      showToast('Group created successfully!', 'success');
      setTimeout(() => {
        window.location.reload();
      }, 700);
    })
    .catch(err => {
      errorEl.textContent = err.message || 'Failed to create group. Try again.';
      errorEl.classList.remove('hidden');
      btn.disabled = false;
    });
  }

  // Create User submit
  function submitInviteUser(e) {
    e.preventDefault();
    const btn = document.getElementById('inviteUserSubmit');
    const name = document.getElementById('inviteUserName').value.trim();
    const email = document.getElementById('inviteUserEmail').value.trim();
    const phone = document.getElementById('inviteUserPhone').value.trim();
    const profilePicture = document.getElementById('inviteUserProfilePicture').files[0];
    const department = document.getElementById('inviteUserDepartment').value;
    const role = document.getElementById('inviteUserRole').value;
    const errorEl = document.getElementById('inviteUserError');

    if (!name || !email) {
      errorEl.textContent = 'Please fill in all required fields.';
      errorEl.classList.remove('hidden');
      return;
    }

    // Validate profile picture if provided
    if (profilePicture) {
      // Check file type
      const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
      if (!validTypes.includes(profilePicture.type)) {
        errorEl.textContent = 'Please upload a valid image file (JPG, JPEG, PNG, or GIF).';
        errorEl.classList.remove('hidden');
        return;
      }
      // Check file size (5MB limit)
      if (profilePicture.size > 5 * 1024 * 1024) {
        errorEl.textContent = 'Image file is too large. Maximum size is 5MB.';
        errorEl.classList.remove('hidden');
        return;
      }
    }

    btn.disabled = true;
    errorEl.classList.add('hidden');

    // Derive a safe username from email
    let derivedUsername = email.split('@')[0].replace(/[^a-zA-Z0-9_.-]/g, '');
    if (!derivedUsername) {
      derivedUsername = 'user' + Date.now();
    }

    // Create FormData object to handle file uploads
    const formData = new FormData();
    formData.append('username', derivedUsername);
    formData.append('full_name', name);
    formData.append('email', email);
    if (phone) formData.append('phone', phone);
    if (profilePicture) formData.append('profile_picture', profilePicture);
    if (department) formData.append('department', department);
    if (role) formData.append('role', role);
    formData.append('is_active', '1');

    const csrfToken = document.querySelector('#inviteUserForm input[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');

    fetch('{% url "dashboard:user_create" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken,
        'Accept': 'application/json'
      },
      body: formData
    })
    .then(async response => {
      const contentType = response.headers.get('content-type') || '';
      const payload = contentType.includes('application/json')
        ? await response.json().catch(() => ({}))
        : { detail: await response.text().catch(() => '') };

      if (!response.ok || payload.success === false) {
        const msg = payload.errors ? Object.values(payload.errors).flat().join(', ') :
                payload.detail || 'Failed to create user.';
        throw new Error(msg);
      }

      return payload;
    })
    .then(data => {
      btn.disabled = false;
      closeModal('inviteUserModal');
      showToast('User created successfully!', 'success');
      setTimeout(() => {
        window.location = '{% url "dashboard:manage_users_all" %}';
      }, 700);
    })
    .catch(err => {
      errorEl.textContent = err.message || 'Failed to create user. Try again.';
      errorEl.classList.remove('hidden');
      btn.disabled = false;
    });
  }
</script>
{% endblock extra_js %}