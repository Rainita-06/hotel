<!-- prettier-ignore -->
{% extends "dashboard/base_dashboard.html" %}
{% load custom_tags %}

{% block title %}Complaints{% endblock %}

{% block dashboard_content %}
<h2>Complaints</h2>

<!-- Add Complaint Button -->
<button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addComplaintModal">
  + Add Complaint
</button>

<!-- Complaints Table -->
<div class="card shadow mb-4">
  <div class="card-header py-3">
    <h6 class="m-0 font-weight-bold text-primary">Complaints</h6>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-bordered" width="100%" cellspacing="0">
        <thead>
          <tr>
            <th>ID</th>
            <th>Subject</th>
            <th>User</th>
            <th>Guest</th>
            <th>Status</th>
            <th>Created At</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% if complaints %}
            {% for complaint in complaints %}
            <tr>
              <td>{{ complaint.id }}</td>
              <td>{{ complaint.subject }}</td>
              <td>{{ complaint.user.username|default:"N/A" }}</td>
              <td>{{ complaint.guest.full_name|default:"N/A" }}</td>
              <td>
                <span class="badge bg-{% if complaint.status == 'open' %}success{% elif complaint.status == 'closed' %}secondary{% else %}warning{% endif %}">
                  {{ complaint.get_status_display }}
                </span>
              </td>
              <td>{{ complaint.created_at|date:"Y-m-d H:i" }}</td>
              <td>
                <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editComplaintModal-{{ complaint.id }}">Edit</button>
                <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteComplaintModal-{{ complaint.id }}">Delete</button>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="7" class="text-center">No complaints found.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Add Complaint Modal -->
<div class="modal fade" id="addComplaintModal" tabindex="-1" aria-labelledby="addComplaintModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="{% url 'dashboard:complaint_create' %}" method="post">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="addComplaintModalLabel">Add New Complaint</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          {{ form.as_p }}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Save Complaint</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Complaint Modals -->
{% for complaint in complaints %}
<div class="modal fade" id="editComplaintModal-{{ complaint.id }}" tabindex="-1" aria-labelledby="editComplaintModalLabel-{{ complaint.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="{% url 'dashboard:complaint_update' complaint.id %}" method="post">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="editComplaintModalLabel-{{ complaint.id }}">Edit Complaint #{{ complaint.id }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Subject -->
          <div class="mb-3">
            <label for="subject-{{ complaint.id }}" class="form-label">Subject</label>
            <input type="text" class="form-control" id="subject-{{ complaint.id }}" name="subject" value="{{ complaint.subject }}">
          </div>
          <!-- User -->
          <div class="mb-3">
            <label for="user-{{ complaint.id }}" class="form-label">User</label>
            <select name="user" id="user-{{ complaint.id }}" class="form-control">
              <option value="">---------</option>
              {% for user in users %}
                <option value="{{ user.id }}" {% if complaint.user and complaint.user.id == user.id %}selected{% endif %}>{{ user.username }}</option>
              {% endfor %}
            </select>
          </div>
          <!-- Guest -->
          <div class="mb-3">
            <label for="guest-{{ complaint.id }}" class="form-label">Guest</label>
            <select name="guest" id="guest-{{ complaint.id }}" class="form-control">
              <option value="">---------</option>
              {% for guest in guests %}
                <option value="{{ guest.id }}" {% if complaint.guest and complaint.guest.id == guest.id %}selected{% endif %}>{{ guest.full_name }}</option>
              {% endfor %}
            </select>
          </div>
          <!-- Status -->
          <div class="mb-3">
            <label for="status-{{ complaint.id }}" class="form-label">Status</label>
            <select name="status" id="status-{{ complaint.id }}" class="form-control">
              <option value="open" {% if complaint.status == "open" %}selected{% endif %}>Open</option>
              <option value="in_progress" {% if complaint.status == "in_progress" %}selected{% endif %}>In Progress</option>
              <option value="closed" {% if complaint.status == "closed" %}selected{% endif %}>Closed</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endfor %}

<!-- Delete Complaint Modals -->
{% for complaint in complaints %}
<div class="modal fade" id="deleteComplaintModal-{{ complaint.id }}" tabindex="-1" aria-labelledby="deleteComplaintModalLabel-{{ complaint.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="{% url 'dashboard:complaint_delete' complaint.id %}" method="post">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="deleteComplaintModalLabel-{{ complaint.id }}">Confirm Deletion</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete complaint #{{ complaint.id }}?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Delete</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endfor %}
{% endblock %}
