{% extends "dashboard/base_dashboard.html" %}
{% load static %}

{% block dashboard_content %}
<div class="container-fluid py-4">
  <div class="row justify-content-center">
    <div class="col-12 col-xl-10">
      <!-- Header -->
      <div class="text-center mb-4">
        <h1 class="h2 fw-bold text-success mb-2">✅ Guest Registration Complete!</h1>
        <p class="text-muted">
          {{ guest.full_name }} has been successfully registered with all details and QR codes generated.
        </p>
      </div>

      <div class="row">
        <!-- Guest Details -->
        <div class="col-lg-6 mb-4">
          <div class="card shadow border-0 h-100">
            <div class="card-header bg-primary bg-opacity-10 border-bottom">
              <h3 class="card-title h5 text-primary mb-0">👤 Guest Information</h3>
            </div>
            <div class="card-body">
              <dl class="row">
                <dt class="col-4">Guest ID:</dt>
                <dd class="col-8">
                  <span class="badge bg-primary fs-6">{{ guest.guest_id }}</span>
                </dd>

                <dt class="col-4">Full Name:</dt>
                <dd class="col-8 fw-medium">{{ guest.full_name|default:"Not provided" }}</dd>

                <dt class="col-4">Phone:</dt>
                <dd class="col-8">
                  {% if guest.phone %}
                    <a href="tel:{{ guest.phone }}" class="text-decoration-none">
                      📞 {{ guest.phone }}
                    </a>
                  {% else %}
                    Not provided
                  {% endif %}
                </dd>

                <dt class="col-4">Email:</dt>
                <dd class="col-8">
                  {% if guest.email %}
                    <a href="mailto:{{ guest.email }}" class="text-decoration-none">
                      📧 {{ guest.email }}
                    </a>
                  {% else %}
                    Not provided
                  {% endif %}
                </dd>

                <dt class="col-4">Room:</dt>
                <dd class="col-8">
                  <span class="badge bg-info fs-6">{{ guest.room_number|default:"Not assigned" }}</span>
                </dd>

                <dt class="col-4">Package:</dt>
                <dd class="col-8">{{ guest.package_type|default:"Standard" }}</dd>

                {% if guest.checkin_datetime %}
                  <dt class="col-4">Check-in:</dt>
                  <dd class="col-8">
                    <strong>{{ guest.checkin_datetime|date:"M d, Y" }}</strong><br>
                    <small class="text-muted">{{ guest.checkin_datetime|time:"h:i A" }}</small>
                  </dd>
                {% endif %}

                {% if guest.checkout_datetime %}
                  <dt class="col-4">Check-out:</dt>
                  <dd class="col-8">
                    <strong>{{ guest.checkout_datetime|date:"M d, Y" }}</strong><br>
                    <small class="text-muted">{{ guest.checkout_datetime|time:"h:i A" }}</small>
                  </dd>
                {% endif %}

                <dt class="col-4">Breakfast:</dt>
                <dd class="col-8">
                  {% if guest.breakfast_included %}
                    <span class="badge bg-success">✅ Included</span>
                  {% else %}
                    <span class="badge bg-secondary">❌ Not included</span>
                  {% endif %}
                </dd>
              </dl>

              {% if vouchers %}
                <div class="mt-4 p-3 bg-warning bg-opacity-10 border border-warning rounded">
                  <h6 class="text-warning-emphasis mb-2">🎫 Vouchers Created:</h6>
                  {% for voucher in vouchers %}
                    <div class="mb-3 pb-3 border-bottom">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>{{ voucher.voucher_type|title }} Voucher</span>
                        <code class="small">{{ voucher.voucher_code }}</code>
                      </div>
                      {% if voucher.qr_image %}
                        <div class="text-center mt-2">
                          <img src="data:image/png;base64,{{ voucher.qr_image }}" 
                               alt="{{ voucher.voucher_type|title }} Voucher QR Code" 
                               class="img-fluid border rounded shadow-sm"
                               style="max-width: 150px;">
                          <div class="mt-2">
                            <a href="data:image/png;base64,{{ voucher.qr_image }}" 
                               download="voucher_{{ voucher.voucher_code }}.png"
                               class="btn btn-outline-warning btn-sm">
                              <i class="fas fa-download me-1"></i> Download
                            </a>
                          </div>
                        </div>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- QR Code Display -->
        <div class="col-lg-6 mb-4">
          <div class="card shadow border-0 h-100">
            <div class="card-header bg-info bg-opacity-10 border-bottom">
              <h3 class="card-title h5 text-info mb-0">📱 Guest Details QR Code</h3>
            </div>
            <div class="card-body text-center">
              {% if guest.details_qr_code %}
                <div class="mb-3">
                  <img src="data:image/png;base64,{{ guest.details_qr_code }}" 
                       alt="Guest Details QR Code" 
                       class="img-fluid border rounded shadow-sm"
                       style="max-width: 300px;">
                </div>
                
                <div class="alert alert-info">
                  <h6 class="alert-heading">📋 QR Code Contains:</h6>
                  <ul class="mb-0 small text-start">
                    <li>Complete guest information</li>
                    <li>Check-in/out date and time</li>
                    <li>Room and package details</li>
                    <li>Breakfast inclusion status</li>
                    <li>Secure verification hash</li>
                  </ul>
                </div>

                <div class="d-flex gap-2 justify-content-center flex-wrap">
                  <a href="data:image/png;base64,{{ guest.details_qr_code }}" 
                     download="guest_{{ guest.guest_id }}_qr.png"
                     class="btn btn-outline-primary btn-sm">
                    💾 Download QR
                  </a>
                  <button type="button" 
                          class="btn btn-outline-info btn-sm"
                          onclick="printQR()">
                    🖨️ Print QR
                  </button>
                  {% if guest.phone %}
                    <button type="button" 
                            class="btn btn-success btn-sm"
                            onclick="shareOnWhatsApp()">
                      📱 Share on WhatsApp
                    </button>
                  {% endif %}
                </div>
              {% else %}
                <div class="text-muted">
                  <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                  <p>QR code generation failed or was not requested.</p>
                  <button type="button" 
                          class="btn btn-outline-primary btn-sm"
                          onclick="generateQR()">
                    🔄 Generate QR Code
                  </button>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- QR Code Details -->
      {% if qr_details %}
        <div class="row mt-4">
          <div class="col-12">
            <div class="card shadow border-0">
              <div class="card-header bg-secondary bg-opacity-10 border-bottom">
                <h3 class="card-title h5 text-secondary mb-0">🔍 QR Code Data Preview</h3>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <h6>Basic Information:</h6>
                    <ul class="list-unstyled small">
                      <li><strong>Type:</strong> {{ qr_details.type|default:"guest_details" }}</li>
                      <li><strong>Guest ID:</strong> {{ qr_details.guest_id }}</li>
                      <li><strong>Name:</strong> {{ qr_details.full_name }}</li>
                      <li><strong>Phone:</strong> {{ qr_details.phone|default:"Not provided" }}</li>
                      <li><strong>Email:</strong> {{ qr_details.email|default:"Not provided" }}</li>
                    </ul>
                  </div>
                  <div class="col-md-6">
                    <h6>Stay Details:</h6>
                    <ul class="list-unstyled small">
                      <li><strong>Room:</strong> {{ qr_details.room_number|default:"Not assigned" }}</li>
                      <li><strong>Package:</strong> {{ qr_details.package_type|default:"Standard" }}</li>
                      {% if qr_details.checkin_datetime %}
                        <li><strong>Check-in:</strong> {{ qr_details.checkin_date }} {{ qr_details.checkin_time }}</li>
                      {% endif %}
                      {% if qr_details.checkout_datetime %}
                        <li><strong>Check-out:</strong> {{ qr_details.checkout_date }} {{ qr_details.checkout_time }}</li>
                      {% endif %}
                      {% if qr_details.stay_duration_hours %}
                        <li><strong>Duration:</strong> {{ qr_details.stay_duration_hours }} hours</li>
                      {% endif %}
                      <li><strong>Breakfast:</strong> {{ qr_details.breakfast_included|yesno:"Yes,No" }}</li>
                    </ul>
                  </div>
                </div>
                <div class="mt-3">
                  <small class="text-muted">
                    🔒 Verification Hash: <code>{{ qr_details.verification_hash }}</code>
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endif %}

      <!-- Action Buttons -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="d-flex flex-wrap gap-3 justify-content-center">
            <a href="{% url 'register_guest' %}" class="btn btn-success">
              ➕ Register Another Guest
            </a>
            <a href="{% url 'dashboard:guests' %}" class="btn btn-primary">
              👥 View All Guests
            </a>
            {% if vouchers %}
              <a href="{% url 'dashboard:vouchers' %}" class="btn btn-warning">
                🎫 View Vouchers
              </a>
            {% endif %}
            <a href="{% url 'dashboard:main' %}" class="btn btn-outline-secondary">
              🏠 Dashboard Home
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function printQR() {
    const qrImage = document.querySelector('img[alt="Guest Details QR Code"]');
    if (qrImage) {
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>Guest QR Code - {{ guest.full_name }}</title>
            <style>
              body { 
                font-family: Arial, sans-serif; 
                text-align: center; 
                padding: 20px; 
              }
              img { 
                max-width: 100%; 
                border: 1px solid #ddd; 
                border-radius: 8px; 
              }
              .info { 
                margin-top: 20px; 
                font-size: 14px; 
                color: #666; 
              }
            </style>
          </head>
          <body>
            <h2>Guest Details QR Code</h2>
            <p><strong>{{ guest.full_name }}</strong> - Room {{ guest.room_number }}</p>
            <img src="${qrImage.src}" alt="Guest QR Code">
            <div class="info">
              <p>Guest ID: {{ guest.guest_id }}</p>
              {% if guest.checkin_datetime and guest.checkout_datetime %}
                <p>Stay: {{ guest.checkin_datetime|date:"M d, Y" }} - {{ guest.checkout_datetime|date:"M d, Y" }}</p>
              {% endif %}
              <p>Generated: ${new Date().toLocaleDateString()}</p>
            </div>
          </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.print();
      printWindow.close();
    }
  }

  function generateQR() {
    // This would trigger an AJAX call to generate QR code
    fetch('/generate-guest-qr/{{ guest.id }}/', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json',
      },
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert('Failed to generate QR code: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Failed to generate QR code');
    });
  }

  function shareOnWhatsApp() {
    // Create a temporary link to download the QR code
    const qrDataUrl = "data:image/png;base64,{{ guest.details_qr_code }}";
    
    // Create guest details text
    let guestDetails = `Guest Details:%0A`;
    guestDetails += `Name: {{ guest.full_name|default:"N/A" }}%0A`;
    guestDetails += `Guest ID: {{ guest.guest_id|default:"N/A" }}%0A`;
    guestDetails += `Room: {{ guest.room_number|default:"N/A" }}%0A`;
    {% if guest.checkin_datetime %}
      guestDetails += `Check-in: {{ guest.checkin_datetime|date:"M d, Y" }} at {{ guest.checkin_datetime|time:"h:i A" }}%0A`;
    {% endif %}
    {% if guest.checkout_datetime %}
      guestDetails += `Check-out: {{ guest.checkout_datetime|date:"M d, Y" }} at {{ guest.checkout_datetime|time:"h:i A" }}%0A`;
    {% endif %}
    
    // For now, we'll share the QR code as a link and the details as text
    // In a more advanced implementation, we could use the WhatsApp Business API to send the actual image
    const phoneNumber = "{{ guest.phone|default:"" }}";
    const message = `Hi, here are your guest details and QR code:%0A%0A${guestDetails}%0AYou can view your QR code at: ${window.location.href}`;
    
    if (phoneNumber) {
      window.open(`https://wa.me/${phoneNumber}?text=${message}`, '_blank');
    } else {
      // Fallback if phone number is not available
      window.open(`https://web.whatsapp.com/send?text=${message}`, '_blank');
    }
  }
</script>
{% endblock %}